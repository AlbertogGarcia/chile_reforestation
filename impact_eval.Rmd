---
title: "impact evaluation"
author: "Albert Garcia"
date: "Nov 11, 2020"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

# Methods

## NDVI time series

I generate NDVI time series for each property from 2007 to 2018 using the following procedure: 
\begin{enumerate}
\item compute NDVI for each Landsat 30m pixel that falls within a relevant property between the years 2007 and 2018
\item for each year, select each pixel's maximum NDVI value
\item to get the property's annual NDVI value, compute the mean NDVI annual maximum value from pixels that fall within the property 
\end{enumerate}

## Event study

I use a difference-in-differences event study to evaluate the impact of the subsidies through time. Treatment properties consist of properties that have been awarded a Native Forest Law subsidy between 2009 and 2018. Three separate types of properties compose my control group: unassigned properties, rejected properties, and 2019 subsidy recipients. I use 2019 recipients as controls, because they have not yet had to implement the project, as projects must be implemented by the second year after receiving the award. This is verified by a third party inspection. The viability of the analysis rests on my claim that treatment properties would have followed the same NDVI trend as control properties through time in the absence of the award. We can partially address this assumption by examining pre-trends, which I discuss later. Given that all properties in the control group have expressed their intent to enroll in the program, it seems reasonable to conclude that they have comparable opportunity costs to enrollment and alternative land-use options. The main concern to this identification assumption is the potential for anticipation effects. In the period prior to treatment, property owners may adjust their land-use in order to account for the possibility of receiving an award in the next year. This concern is mitigated in two ways: 1) Outcomes in the period immediately prior to treatment do not display a drop in NDVI consistently across groups;and 2) a robustness check in which I exclude the period immediately prior to treatment yields qualitatively similar results. I will discuss these two factors in detail in the results. 

## Why aggregate to property level?

## Why aggregate group-time treatment effects ex-post?

I use the difference-in-differences estimator proposed by Callaway and Santa'ana (2019) to mitigate concerns over issues surrounding the use of TWFE models in the presence of heterogeneous treatment effects. This amounts to first using a generalized propensity score method to better compare treatment and control units based on a set of covariates. Then, for each cohort, I compute the standard DID event study, before aggregating the group-time treatment effects with weights corresponding to each group's representativeness in the sample. This ensures that the weights for each group-time treatment effect are not negative, and therefore, do not risk reversing the sign of the treatment effect estimate.

The current set of covariates includes:
\begin{itemize}
\item property characteristics (lattitude, longitude, area in hectares, etc. )
\item award characteristics (hectares subsidized, money awarded, primary project objective, etc.)
\end{itemize}

## Anticipation considerations

# Preliminary results from preferred specification

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tinytex)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(rio)
#library(DIDmultiplegt)
# library(devtools)
# install_github("bcallaway11/did")
library(did)
library(qte)

```

``` {r NFL_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

#setwd("C:/Users/garci/Desktop/chile_data")

#projects
awarded_panel <- readRDS("awarded_panel.rds")%>%
  mutate(area_ha = ifelse(is.na(rptpre_superficie_predial), SUPERFICIE, rptpre_superficie_predial))
rejected_panel_b <- readRDS("rejected_panel_2.rds")%>%
  bind_rows(readRDS("rejected_panel.rds"))%>%
  distinct(Year, ID, .keep_all = TRUE)

full_panel_2006 <- awarded_panel %>%
  bind_rows(rejected_panel)%>%
  filter( Year < 2019 ) %>%#Year >= 2006&
  mutate(smallholder = ifelse(rptpro_tipo_concurso=="Otros Interesados", 0, 1))
```


``` {r df, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
library(gridExtra)


full_panel <- full_panel_2006 %>%
  mutate(treat = ifelse(rptpro_ano ==2019, 0, treat))
full_panel$ID <- as.numeric(full_panel$ID)
```


## comparing performance of larger properties ("other interested parties") vs. smallholders

While the average NDVI of both other interested party and smallholder landowners is nearly identical at .857 and .858, the property sizes are rather different. The median smallholder property is 32.11 hectares, while the median other interested party property is 1142.8 hectares. The average subsidy for larger properties is 69.3UTM(~/$4000), while it is 23.81UTM (~/$1400) for smallholders.


``` {r did otros interesados, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

aw_otros <- full_panel %>%
  filter(rptpro_tipo_concurso == "Otros Interesados" &
           treat==1)%>%
  filter(plantacion==1|`plantacion-suplementaria`==1|regeneracion==1)


otros_panel <- full_panel %>%
  filter(rptpro_tipo_concurso == "Otros Interesados" )%>%
  #filter(plantacion==1|`plantacion-suplementaria`==1|regeneracion==1)%>%
  mutate(rptpro_monto_total = ifelse(is.na(rptpro_monto_total), 0, rptpro_monto_total)
         )%>%
  distinct(ID, Year, .keep_all = TRUE)#%>%
  # filter( (rptpro_puntaje > quantile(aw_otros$rptpro_puntaje, 0.25) &
  #           rptpro_puntaje < quantile(aw_otros$rptpro_puntaje, .5))
  #         | treat ==0)

# did_otros <- mp.spatt(NDVI ~ treat, data= otros_panel,
#                 xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha,
#                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
#                 )
# 
# summary(did_otros)
first_awarded$prop_ID <- as.character(first_awarded$prop_ID)
otros_panel <- first_awarded %>%
  rename(ID = prop_ID)%>%
  bind_rows(rejected_panel)%>%
  filter(rptpro_tipo_concurso == "Otros Interesados")
otros_panel$ID <- as.numeric(otros_panel$ID)
did.att.gt <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="ID",
                     gname="first.treat",
                     #xformla=~  lat+long+rptpro_monto_total,
                     data=otros_panel, clustervars = "ID"
                     #,panel=TRUE, bstrap = TRUE, cband = TRUE
                     )
summary(did.att.gt)

did.es <- aggte(did.att.gt, type="dynamic", na.rm = TRUE)#, min_e=-5, max_e = 9)
did.simple <- aggte(did.att.gt, type = "simple", na.rm=TRUE)
# plot the event study
ggdid(did.es)
summary(did.simple)

```

``` {r qte test, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
qte_df <- otros_panel %>%
  filter(first.treat==2009|first.treat==0)%>%
  mutate(treat = ifelse(is.na(treat), 0, treat))


c1 <- CiC(NDVI ~ treat, t=2015, tmin1=2008, tname="Year",
 xformla=~lat+long+rptpro_monto_total,
 data=qte_df, idname="ID", se=TRUE,
 probs=seq(0.05, 0.95, 0.05))
summary(c1)
ggqte(c1)
```

### other interested parties

We see that other interested parties perform relatively well. Pre-trends largely seem to hold based on individual cohorts. The vast majority are not statistically different from zero, and there is no clear trend indicating that land use changes in trend prior to receiving the subsidy. We fail to reject the null that all pre-trend estimates are statistically different from zero. It is also reassuring that several different cohorts exhibit positive treatment effects through time, indicating that the effect is not overly driven by a few observations or a single  cohort. 
``` {r did otros interesados plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
ggdid(did_otros)
ggsave(plot = ggdid(did_otros),
       path = "figs",
  filename = "otros_cohorts.png",
  width = 8,
  units = "in",
  dpi = 500)

ggdid(did_otros, type = "dynamic")

ggsave(path = "figs", filename = "otros_dynamic.png", dpi = 500)

```


### smallholders

Here, we see that smallholders see no statistically significant treatment effect from receiving a subsidy. There is a downward trend of the point estimates in fact. None of the pre-trends are statistically different from zero, and the joint hypothesis test indicates no issues. They also exhibit no worrying trends. 

``` {r did smallholders, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

smallholder_panel <- full_panel %>%
  filter(rptpro_tipo_concurso != "Otros Interesados")

did_sh <- mp.spatt(NDVI ~ treat, data= smallholder_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha ,
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )


summary(did_sh$aggte, type="dynamic")
```

``` {r did smallholders plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
ggdid(did_sh)
ggsave(plot = ggdid(did_sh),
       path = "figs",
  filename = "sh_cohorts.png",
  width = 8,
  units = "in",
  dpi = 500)
ggdid(did_sh, type = "dynamic")
ggsave(path = "figs", filename = "sh_dynamic.png", dpi = 500)

```

\clearpage

## Exploring other potentially important sub-stories

### reforestation specific projects
``` {r did reforestation, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

# reforestation_panel <- awarded_panel %>%
#   filter(plantacion == 1 | `plantacion-suplementaria`==1 | `corta-regeneracion` ==1|regeneracion==1|enriquecimiento==1)%>%
#   bind_rows(rejected_panel)%>%
#   filter( Year < 2019 ) %>%#Year >= 2006&
#   mutate(smallholder = ifelse(rptpro_tipo_concurso=="Otros Interesados", 0, 1))

reforestation_panel <- full_panel %>%
  filter(plantacion == 1 | `plantacion-suplementaria`==1 | `corta-regeneracion` ==1|regeneracion==1|enriquecimiento==1)

ref_otros_panel <- reforestation_panel %>%
  filter(smallholder == 0)
ref_sh_panel <- reforestation_panel %>%
  filter(smallholder == 1)



did_ref <- mp.spatt(NDVI ~ treat, data= reforestation_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha ,
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )

did_ref_otros <- mp.spatt(NDVI ~ treat, data= ref_otros_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha,
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )

did_ref_sh <- mp.spatt(NDVI ~ treat, data= ref_sh_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha,
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )
```

``` {r did reforestation plots, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
ggdid(did_ref_otros)
ggsave(plot = ggdid(did_ref_sh),
       path = "figs",
  filename = "sh_ref_cohorts.png",
  width = 8,
  units = "in",
  dpi = 500)

ggsave(plot = ggdid(did_ref_otros),
       path = "figs",
  filename = "otros_ref_cohorts.png",
  width = 8,
  units = "in",
  dpi = 500)
      
ggdid(did_ref_otros, type = "dynamic")
ggsave(path = "figs", filename = "otros_reforest_dynamic.png", dpi = 500)

ggdid(did_ref_sh, type = "dynamic")
ggsave(path = "figs", filename = "sh_reforest_dynamic.png", dpi = 500)

```




# Accounting for limited treatment anticipation

Although not the preferred specification, I now check to see how robust these results are when accounting for one-period of possible anticipation. For all estimates, I drop the period immediately prior to treatment, so that the treatment effect estimates are based on the t-2 period (where t is the year of treatment).


``` {r anticipation dataframe, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

ant_panel <- full_panel %>%
  mutate(first.treat = ifelse(first.treat >0, as.numeric(first.treat) - 1, 0))
```

## comparing performance of larger properties ("other interested parties") vs. smallholders

``` {r did otros interesados ant, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

otros_ant_panel <- ant_panel %>%
  filter(rptpro_tipo_concurso == "Otros Interesados" )

did_otros_ant <- mp.spatt(NDVI ~ treat, data= otros_ant_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha, 
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )

```

### other interested parties


``` {r did otros interesados plots ant, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

ggdid(did_otros_ant, type = "dynamic")
ggsave(path = "figs", filename = "anticipation_otros_dynamic.png", dpi = 500)
```


### smallholders

Here, we see that smallholders see no statistically significant treatment effect from receiving a subsidy. There is a downward trend of the point estimates in fact. None of the pre-trends are statistically different from zero, nor do they exhibit any worrying trends. 

``` {r did smallholders ant, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

smallholder_ant_panel <- ant_panel %>%
  filter(rptpro_tipo_concurso != "Otros Interesados")

did_sh_ant <- mp.spatt(NDVI ~ treat, data= smallholder_ant_panel,
                xformla=~ rptpro_monto_total + lat + rptpre_superficie_bonificada + area_ha, 
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", bstrap=TRUE, se=TRUE, cband=TRUE, cluster = "ID"
                )

```

``` {r did smallholders plots ant, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

ggdid(did_sh_ant, type = "dynamic")
ggsave(path = "figs", filename = "anticipation_sh_dynamic.png", dpi = 500)

```

