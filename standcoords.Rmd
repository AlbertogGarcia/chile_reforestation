---
title: "preliminary stand analysis"
author: "Albert Garcia"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tinytex)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(kableExtra)
library(stringdist)
library(GADMTools)
library(rnaturalearth)

library(did)
library(AER)
library(dynlm)
library(plm)
library(stargazer)
library(Metrics)
library(DataCombine)

source('LLcrs_clean_fcn.R')
```




``` {r NFL_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

setwd("C:/Users/garci/Desktop/chile_data/nativeforestlaw")

# xls files downloaded from CONAF
#projects
proyecto_1 <- read_excel("proyectos_1.xls")
proyecto_2 <- read_excel("proyectos_2.xls")
proyecto_df <- merge(proyecto_1, proyecto_2, by = c("rptpro_id", "rptpro_numero_ingreso"), all=TRUE)
#properties and coordinates
predio_df <- read_excel("predio.xls")
coordinadas_predio_df <- read_excel("coordinadas_predio.xls")
#owners
propietario_df <- read_excel("propietario.xls")
#stands
rodal_1 <- read_excel("rodal_1.xls")
rodal_2 <- read_excel("rodal_2.xls")
rodal_df <- merge(rodal_1, rodal_2, by = c("rptro_id"), all=TRUE)
#activities
actividades_1 <- read_excel("actividades_1.xls")
actividades_2 <- read_excel("actividades_2.xls")
actividades_df <- merge(actividades_1, actividades_2, by = c("rptac_id"), all=TRUE)
#fences
cercos_df <- read_excel("cerco.xls")

#merging into full data set
df_NFL <- proyecto_df %>%
  left_join(predio_df, by = c("rptpro_id", "rptpro_numero_ingreso")) %>%
  left_join(propietario_df, by = "rptpre_id") %>%
  left_join(coordinadas_predio_df, by = "rptpre_id") %>%
  left_join(rodal_df, by = "rptpre_id") %>%
  left_join(actividades_df, by = "rptro_id")


#northing easting huso datum
df_full <- df_NFL %>%
  mutate(northing = 
           ifelse(is.na(rptro_norte), rptub_norte, rptro_norte)
         ) %>%
  mutate(easting = 
           ifelse(is.na(rptro_este), rptub_este, rptro_este)
         ) %>%
  mutate(datum = 
           ifelse(is.na(rptro_este) | is.na(rptro_norte), rptub_datum, rptro_datum)
         ) %>%
  mutate(huso = 
           ifelse(is.na(rptro_este) | is.na(rptro_norte), rptub_huso, rptro_huso)
         ) %>%
  mutate(awarded = 1)

```



``` {r stands, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

#using crs_clean_fcn to use common projection
new_df.sf <- LLcrs_clean_fcn(df_full) #outputs sf df with common projection (sad69 zone 19s)

stand_df <- new_df.sf %>%
  drop_na(rptro_este | rptro_norte) %>%
  select(rptpro_id, rptpre_rol, rptpro_objetivo_manejo, rptro_id, rptpro_tipo_concurso, rptpro_puntaje, rptpro_ano, rptpre_id, rptpre_comuna, rptpre_region, rptro_superficie, rptro_tipo_forestal, rptro_especie, rptac_ano_inicio, rptac_ano_fin, rptac_tipo, rptac_estado_desarrollo, rptac_monto_actividad)

```



``` {r chile maps, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

#chile_bounds <- st_as_sf(st_read("C:/Users/garci/Desktop/chile_data/GADM/gadm36_CHL_shp/gadm36_CHL_0.shp"))

chile_bounds <- ne_countries(country = "Chile", returnclass = "sf")
```



``` {r regen activities, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

regen_df <- stand_df %>%
  filter(rptac_tipo == "regeneracion" |
           rptac_tipo == "plantacion-suplementaria" |
           rptac_tipo == "plantacion" 
         | rptac_tipo == "enriquecimiento"
  ) %>%
  st_intersection(chile_bounds)

```

``` {r gee dataframe, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

gee_df <- regen_df %>%
  mutate(lat = unlist(map(regen_df$geometry,1)),
         long = unlist(map(regen_df$geometry,2)))

gee_df$geometry <- NULL
gee_df <- gee_df %>% 
  select(lat, long, rptro_id, rptpre_region, rptro_superficie) %>%
  distinct()

table(gee_df$rptpre_region)
```

``` {r region files, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = FALSE}
  
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Aysen del General Carlos Ibáñez del Campo")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_campo.txt", row.names = FALSE)
# write.csv(lat, file = "lat_campo.txt", row.names = FALSE)
# write.csv(long, file = "long_campo.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región del Libertador General Bernardo O'Higgins")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_ohiggins.txt", row.names = FALSE)
# write.csv(lat, file = "lat_ohiggins.txt", row.names = FALSE)
# write.csv(long, file = "long_ohiggins.txt", row.names = FALSE)
# 
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región del Bío-Bío")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_biobio.txt", row.names = FALSE)
# write.csv(lat, file = "lat_biobio.txt", row.names = FALSE)
# write.csv(long, file = "long_biobio.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región del Maule")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_maule.txt", row.names = FALSE)
# write.csv(lat, file = "lat_maule.txt", row.names = FALSE)
# write.csv(long, file = "long_maule.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Coquimbo")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_coquimbo.txt", row.names = FALSE)
# write.csv(lat, file = "lat_coquimbo.txt", row.names = FALSE)
# write.csv(long, file = "long_coquimbo.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de La Araucanía")
# 
# lat <- paste0( reg_df$lat[1:150], collapse=",")
# long <- paste0( reg_df$long[1:150], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[1:150], collapse=",")
# write.csv(poly_code, file = "code_araucania_1.txt", row.names = FALSE)
# write.csv(lat, file = "lat_araucania_1.txt", row.names = FALSE)
# write.csv(long, file = "long_araucania_1.txt", row.names = FALSE)
# 
# lat <- paste0( reg_df$lat[151:300], collapse=",")
# long <- paste0( reg_df$long[151:300], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[151:300], collapse=",")
# write.csv(poly_code, file = "code_araucania_2.txt", row.names = FALSE)
# write.csv(lat, file = "lat_araucania_2.txt", row.names = FALSE)
# write.csv(long, file = "long_araucania_2.txt", row.names = FALSE)
# 
# lat <- paste0( reg_df$lat[301:446], collapse=",")
# long <- paste0( reg_df$long[301:446], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[301:446], collapse=",")
# write.csv(poly_code, file = "code_araucania_3.txt", row.names = FALSE)
# write.csv(lat, file = "lat_araucania_3.txt", row.names = FALSE)
# write.csv(long, file = "long_araucania_3.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Los Lagos")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_lagos.txt", row.names = FALSE)
# write.csv(lat, file = "lat_lagos.txt", row.names = FALSE)
# write.csv(long, file = "long_lagos.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Los Ríos")
# 
# lat <- paste0( reg_df$lat[1:150], collapse=",")
# long <- paste0( reg_df$long[1:150], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[1:150], collapse=",")
# write.csv(poly_code, file = "code_rios_1.txt", row.names = FALSE)
# write.csv(lat, file = "lat_rios_1.txt", row.names = FALSE)
# write.csv(long, file = "long_rios_1.txt", row.names = FALSE)
# 
# lat <- paste0( reg_df$lat[151:300], collapse=",")
# long <- paste0( reg_df$long[151:300], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[151:300], collapse=",")
# write.csv(poly_code, file = "code_rios_2.txt", row.names = FALSE)
# write.csv(lat, file = "lat_rios_2.txt", row.names = FALSE)
# write.csv(long, file = "long_rios_2.txt", row.names = FALSE)
# 
# lat <- paste0( reg_df$lat[301:410], collapse=",")
# long <- paste0( reg_df$long[301:410], collapse=",")
# poly_code <- paste0( reg_df$rptro_id[301:410], collapse=",")
# write.csv(poly_code, file = "code_rios_3.txt", row.names = FALSE)
# write.csv(lat, file = "lat_rios_3.txt", row.names = FALSE)
# write.csv(long, file = "long_rios_3.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Valparaíso")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_valparaiso.txt", row.names = FALSE)
# write.csv(lat, file = "lat_valparaiso.txt", row.names = FALSE)
# write.csv(long, file = "long_valparaiso.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Ñuble")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_nuble.txt", row.names = FALSE)
# write.csv(lat, file = "lat_nuble.txt", row.names = FALSE)
# write.csv(long, file = "long_nuble.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%filter(rptpre_region == "Región Metropolitana de Santiago")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_santiago.txt", row.names = FALSE)
# write.csv(lat, file = "lat_santiago.txt", row.names = FALSE)
# write.csv(long, file = "long_santiago.txt", row.names = FALSE)
# ###########################################################################
# 
# reg_df <- gee_df %>%
#   filter(rptpre_region == "Región de Antofagasta" | rptpre_region == "Region de Arica y Parinacota" |rptpre_region == "Región de Atacama" | rptpre_region == "Región de Magallanes y la Antártica Chilena" | rptpre_region == "Región de Tarapacá")
# 
# lat <- paste0( reg_df$lat, collapse=",")
# long <- paste0( reg_df$long, collapse=",")
# poly_code <- paste0( reg_df$rptro_id, collapse=",")
# 
# write.csv(poly_code, file = "code_other.txt", row.names = FALSE)
# write.csv(lat, file = "lat_other.txt", row.names = FALSE)
# write.csv(long, file = "long_other.txt", row.names = FALSE)

```

``` {r unique stands, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

regenstands_df <- regen_df
regenstands_df$geometry <- NULL
regenstands_df <- regenstands_df %>%
  select(rptpro_id, rptpre_rol, rptpro_objetivo_manejo, rptro_id, rptpro_tipo_concurso, rptpro_puntaje, rptpro_ano, rptpre_id, rptpre_comuna, rptpre_region, rptro_superficie, rptro_tipo_forestal, rptro_especie, rptac_ano_inicio, rptac_ano_fin, rptac_tipo, rptac_estado_desarrollo, rptac_monto_actividad) %>%
  distinct() 
  
```

``` {r NDVI data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

setwd("C:/Users/garci/Desktop/chile_data/stand_ndvi_100m")

#upload and bind csvs together

stand_ndvi <- 
  list.files(pattern = "*.csv") %>% 
  map_df(~read_csv(.)) %>%
  as.data.frame() %>% #turn into dataframe
  rename(rptro_id = Code)
  
#join with regen stand dataframe to get panel
panel_ndvi <- stand_ndvi %>%
  left_join(regenstands_df, by = "rptro_id") %>%#rename code to original stand id name
  distinct()
```

# Regression estimates
All of the below regressions follow the following form:
\begin{align}
y_{it} = &\alpha + \beta_0 D_{it} + \gamma_i + \lambda_t + X_{i}+ \epsilon_{it} 
\end{align}
\begin{align}
y_{it} = &\alpha + \beta_0 D_{it} + \sum_{m=1}^9\beta_mD_{i,t-m} + \gamma_i + \lambda_t + X_{i}+ \epsilon_{it} 
\end{align}
\begin{align}
y_{it} = &\alpha + \beta_0 D_{it} + \sum_{m=1}^5\beta_mD_{i,t-m} + \gamma_i + \lambda_t + X_{i}+ \epsilon_{it} 
\end{align}
, where $D_{it}$ is a dummy equal to one if stand $i$ is part of an awarded project in period $t$. $\gamma_i$ and $\lambda_t$ represent stand and time fixed effects, respectively. 

All of the plots follow specification (2), which has lags covering the first 10 years of treatment. There are no rejected units in these specifications, as the stand coordinates were not available for those projects. So this is just staggered adoption of the award on each stand. I haven't looked at pre-trends yet either. I don't think we will interpret these as causal without any rejected stand coordinates, moreso a description of what happens on a typical stand undergoing treatment. 

``` {r dynamic effect event study, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results='asis'}

dynamic_ndvi <- panel_ndvi %>%
  mutate(first.treat = rptpro_ano, 
         treat = (Year >= rptpro_ano)*1) %>%
  distinct()

dynamic_ndvi <- dynamic_ndvi %>%
  distinct(Year, rptro_id, .keep_all = TRUE) 

#adding lags for dynamic treament
dynamic_ndvi <- dynamic_ndvi[order(dynamic_ndvi$rptro_id, dynamic_ndvi$Year),]
dynamic_ndvi <- dynamic_ndvi %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_1", slideBy = -1, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_2", slideBy = -2, reminder = FALSE)%>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_3", slideBy = -3, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_4", slideBy = -4, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_5", slideBy = -5, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_6", slideBy = -6, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_7", slideBy = -7, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_8", slideBy = -8, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat_9", slideBy = -9, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat1", slideBy = +1, reminder = FALSE) %>%
  slide(Var = "treat", GroupVar = "rptro_id", NewVar = "treat2", slideBy = +2, reminder = FALSE) 

ndvi_dyn <- plm(NDVI ~ 
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                 +treat_6 
                 +treat_7
                 #+treat_8
                 #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = dynamic_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

ndvi_dyn2 <- plm(NDVI ~
                +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = dynamic_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(ndvi_dyn)

ndvi_mod <- plm(NDVI ~
                +treat
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = dynamic_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#making plots with confidence intervals
#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(ndvi_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(ndvi_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(ndvi_mod, type = "HC0", cluster = "group")))

stargazer(ndvi_mod, ndvi_dyn, ndvi_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Chile Results", align=TRUE, no.space=TRUE, header=FALSE)

```





``` {r dynamic plot1, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results='asis'}
#making plots with confidence intervals
#plot w/ CIs
plot_df <- data.frame(x = 1:length(ndvi_dyn$coefficients), 
                      coeff = ndvi_dyn$coefficients,
                      lower_95 = ndvi_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = ndvi_dyn$coefficients + 1.96 *cluster_se_dyn
)



ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment in Chile") +
    xlab("year of treatment") + ylab("effect of award on NDVI")


```
# By region

## Los Rios

```{r los rios dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}

losrios_ndvi <- dynamic_ndvi %>%
filter(rptpre_region == "Región de Los Ríos")

losrios_dyn <- plm(NDVI ~ 
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = losrios_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(losrios_dyn)
losrios_dyn2 <- plm(NDVI ~ 
               +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
               +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = losrios_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

losrios_mod <- plm(NDVI ~
                +treat
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = losrios_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(losrios_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(losrios_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(losrios_mod, type = "HC0", cluster = "group")))

stargazer(losrios_mod, losrios_dyn, losrios_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Los Rios Results", align=TRUE, no.space=TRUE, header=FALSE)

#making plots with confidence intervals

#plot w/ CIs
plot_df <- data.frame(x = 1:length(losrios_dyn$coefficients), 
                      coeff = losrios_dyn$coefficients,
                      lower_95 = losrios_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = losrios_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for region of Los Rios") +
    xlab("year of treatment") + ylab("effect of award on NDVI") 

```

## Araucania

```{r araucania dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}

araucania_ndvi <- dynamic_ndvi %>%
filter(rptpre_region == "Región de La Araucanía")

araucania_dyn <- plm(NDVI ~ 
                +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = araucania_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(araucania_dyn)
araucania_dyn2 <- plm(NDVI ~ 
                +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = araucania_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

araucania_mod <- plm(NDVI ~ 
                +treat
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = araucania_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(araucania_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(araucania_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(araucania_mod, type = "HC0", cluster = "group")))

stargazer(araucania_mod, araucania_dyn, araucania_dyn, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Araucania Results", align=TRUE, no.space=TRUE, header=FALSE)


#making plots with confidence intervals

#plot w/ CIs
plot_df <- data.frame(x = 1:length(araucania_dyn$coefficients), 
                      coeff = araucania_dyn$coefficients,
                      lower_95 = araucania_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = araucania_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for region of Araucania") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

## Regions other than Los Rios and Araucania

```{r others dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}

others_ndvi <- dynamic_ndvi %>%
filter(rptpre_region != "Región de La Araucanía" & rptpre_region != "Región de Los Ríos")

others_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = others_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(others_dyn)

others_dyn2 <- plm(NDVI ~  
               +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = others_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


others_mod <- plm(NDVI ~  
                +treat
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = others_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(others_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(others_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(others_mod, type = "HC0", cluster = "group")))

stargazer(others_mod, others_dyn, others_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Other Regions Results", align=TRUE, no.space=TRUE,header=FALSE)



#plot w/ CIs
plot_df <- data.frame(x = 1:length(others_dyn$coefficients), 
                      coeff = others_dyn$coefficients,
                      lower_95 = others_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = others_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for other regions") +
    xlab("year of treatment") + ylab("effect of award on NDVI")
```


# by objective

## timber products

```{r timber dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}
timber_ndvi <- dynamic_ndvi %>%
filter(rptpro_objetivo_manejo == "PRODUCCION MADERERA")

timber_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal)  + as.factor(rptpro_tipo_concurso), 
                            data   = timber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(others_dyn)

timber_dyn2 <- plm(NDVI ~  
               +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_tipo_concurso), 
                            data   = timber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


timber_mod <- plm(NDVI ~  
                +treat
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_tipo_concurso), 
                            data   = timber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(timber_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(timber_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(timber_mod, type = "HC0", cluster = "group")))

stargazer(timber_mod, timber_dyn, timber_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Timber production objective Results", align=TRUE, no.space=TRUE,header=FALSE)



#plot w/ CIs
plot_df <- data.frame(x = 1:length(timber_dyn$coefficients), 
                      coeff = timber_dyn$coefficients,
                      lower_95 = timber_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = timber_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for other regions") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

## non-timber products

```{r non timber dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}
nontimber_ndvi <- dynamic_ndvi %>%
filter(rptpro_objetivo_manejo == "PRODUCCION NO MADERERA")

nontimber_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal)  + as.factor(rptpro_tipo_concurso), 
                            data   = nontimber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(others_dyn)

nontimber_dyn2 <- plm(NDVI ~  
               +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_tipo_concurso), 
                            data   = nontimber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


nontimber_mod <- plm(NDVI ~  
                +treat
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) +  as.factor(rptpro_tipo_concurso), 
                            data   = nontimber_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(nontimber_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(nontimber_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(nontimber_mod, type = "HC0", cluster = "group")))

stargazer(nontimber_mod, nontimber_dyn, nontimber_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Timber production objective Results", align=TRUE, no.space=TRUE,header=FALSE)



#plot w/ CIs
plot_df <- data.frame(x = 1:length(nontimber_dyn$coefficients), 
                      coeff = nontimber_dyn$coefficients,
                      lower_95 = nontimber_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = nontimber_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for other regions") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

# formacions of high value
```{r xera formacions of high value dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE, results = 'asis'}
xera_ndvi <- dynamic_ndvi %>%
filter(rptpro_objetivo_manejo != "PRODUCCION NO MADERERA" & rptpro_objetivo_manejo != "PRODUCCION MADERERA")

xera_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal)  + as.factor(rptpro_tipo_concurso), 
                            data   = xera_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )
#summary(others_dyn)

xera_dyn2 <- plm(NDVI ~  
               +treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
               # +treat_6 
                #+treat_7
                #+treat_8
                #+treat_9
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) + as.factor(rptpro_tipo_concurso), 
                            data   = xera_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


xera_mod <- plm(NDVI ~  
                +treat
              +rptac_monto_actividad + rptpro_puntaje
                +as.factor(rptro_tipo_forestal) +  as.factor(rptpro_tipo_concurso), 
                            data   = xera_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )


#clustered standard errors at stand level
cluster_se_dyn = sqrt(diag(vcovHC(xera_dyn, type = "HC0", cluster = "group")))
cluster_se_dyn2 = sqrt(diag(vcovHC(xera_dyn2, type = "HC0", cluster = "group")))
cluster_se_mod = sqrt(diag(vcovHC(xera_mod, type = "HC0", cluster = "group")))

stargazer(xera_mod, xera_dyn, xera_dyn2, se=list(cluster_se_mod, cluster_se_dyn, cluster_se_dyn2), title="Non-timber production objective Results", align=TRUE, no.space=TRUE,header=FALSE)



#plot w/ CIs
plot_df <- data.frame(x = 1:length(xera_dyn$coefficients), 
                      coeff = xera_dyn$coefficients,
                      lower_95 = xera_dyn$coefficients - 1.96 *cluster_se_dyn,
                      upper_95 = xera_dyn$coefficients + 1.96 *cluster_se_dyn
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for other regions") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

# By Forest Type



## ro-ra-co

```{r ro-ra-co dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

roraco_ndvi <- dynamic_ndvi %>%
filter(rptro_tipo_forestal == "ro-ra-co")

roraco_dyn <- plm(NDVI ~ 
               treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = roraco_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#making plots with confidence intervals
#clustered standard errors at stand level
cluster_se = sqrt(diag(vcovHC(roraco_dyn, type = "HC0", cluster = "group")))
#plot w/ CIs
plot_df <- data.frame(x = 1:length(roraco_dyn$coefficients),  
                      coeff = roraco_dyn$coefficients,
                      lower_95 = roraco_dyn$coefficients - 1.96 *cluster_se,
                      upper_95 = roraco_dyn$coefficients + 1.96 *cluster_se
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for ro-ra-co stands") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

## Esclerofilo

```{r sclerofil dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

esclerofilo_ndvi <- dynamic_ndvi %>%
filter(rptro_tipo_forestal == "esclerofilo")

esclerofilo_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = esclerofilo_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#making plots with confidence intervals
#clustered standard errors at stand level
cluster_se = sqrt(diag(vcovHC(esclerofilo_dyn, type = "HC0", cluster = "group")))
#plot w/ CIs
plot_df <- data.frame(x = 1:length(esclerofilo_dyn$coefficients),  
                      coeff = esclerofilo_dyn$coefficients,
                      lower_95 = esclerofilo_dyn$coefficients - 1.96 *cluster_se,
                      upper_95 = esclerofilo_dyn$coefficients + 1.96 *cluster_se
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for stands") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```

## Siempreverde (evergreen)

```{r evrgreen dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

siempre_ndvi <- dynamic_ndvi %>%
filter(rptro_tipo_forestal == "siempreverde")

siempre_dyn <- plm(NDVI ~  
               treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = siempre_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#making plots with confidence intervals
#clustered standard errors at stand level
cluster_se = sqrt(diag(vcovHC(siempre_dyn, type = "HC0", cluster = "group")))
#plot w/ CIs
plot_df <- data.frame(x = 1:length(siempre_dyn$coefficients), 
                      coeff = siempre_dyn$coefficients,
                      lower_95 = siempre_dyn$coefficients - 1.96 *cluster_se,
                      upper_95 = siempre_dyn$coefficients + 1.96 *cluster_se
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for evergreen stands") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```



## other types of forest
```{r other forest types dynamic effect, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

type_ndvi <- dynamic_ndvi %>%
filter(rptro_tipo_forestal != "esclerofilo" & rptro_tipo_forestal != "siempreverde" & rptro_tipo_forestal != "ro-ra-co")

type_dyn <- plm(NDVI ~  
                treat
                +treat_1 
                +treat_2 
                + treat_3 
                +treat_4
                +treat_5
                +treat_6 
                +treat_7
                #+treat_8
                #+treat_9
                +rptac_monto_actividad + rptpro_puntaje
                + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso), 
                            data   = type_ndvi, 
                            method = "within", #fixed effects model
                            effect = "twoway", #grid and year fixed effects
                            index  = c("rptro_id", "Year")
    )

#making plots with confidence intervals
#clustered standard errors at stand level
cluster_se = sqrt(diag(vcovHC(type_dyn, type = "HC0", cluster = "group")))
#plot w/ CIs
plot_df <- data.frame(x = 1:length(type_dyn$coefficients),
                      coeff = type_dyn$coefficients,
                      lower_95 = type_dyn$coefficients - 1.96 *cluster_se,
                      upper_95 = type_dyn$coefficients + 1.96 *cluster_se
)

ggplot(plot_df, aes(x = x, y = coeff)) +
  geom_point(size = 4) +
  geom_line()+
  geom_linerange(aes(ymax = upper_95, ymin = lower_95)) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")+
    ggtitle("Time varying treatment for stands") +
    xlab("year of treatment") + ylab("effect of award on NDVI")

```













``` {r match awarded by rol, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

# rol_df3 <- df_full %>%
#   rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
#   inner_join(reg3.sf, by = "ROL") %>%#merge by rol
#   filter(rptpre_region == "Región de Atacama")
# 
# rol_df4 <- df_full %>%
#   rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
#   inner_join(reg4.sf, by = "ROL") %>%#merge by rol
#   filter(rptpre_region == "Región de Coquimbo")
# 
# rol_df11 <- df_full %>%
#   rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
#   inner_join(reg11.sf, by = "ROL") %>%#merge by rol
#   filter(rptpre_region == "Región de Aysen del General Carlos Ibáñez del Campo")
# 
# rol_df12 <- df_full %>%
#   rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
#   inner_join(reg12.sf, by = "ROL") %>% #joining based on Rol id with CIREN data
#   filter(rptpre_region == "Región de Magallanes y la Antártica Chilena")
# 
# rol_df <- df_full %>%
#   rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
#   rename(Region = rptpre_region) %>%
#   left_join(region_nombres, by = "Region") %>%
#   inner_join(prop_rural.sf, by = "ROL") %>% #merge by rol
#   mutate(region_CIREN = 
#            ifelse(Region == "Región de Ñuble" & region == 8, 16, region)
#          ) %>%
#   mutate(region_CIREN = 
#            ifelse(Region == "Región de Los Ríos" & region == 10, 14, region_CIREN)
#          ) %>%
#   filter(region_number == region_CIREN) %>%
#   bind_rows(rol_df3) %>%
#   bind_rows(rol_df4) %>%
#   bind_rows(rol_df11) %>%
#   bind_rows(rol_df12) %>%
#   mutate(DESCCOMU = 
#            ifelse(is.na(DESCCOMU), COMUNAS, DESCCOMU)
#          ) 
# 
# rol_df_comuna <- rol_df %>%
#   mutate(comuna_stringd = stringdist(rptpre_comuna, DESCCOMU, method = "dl")) %>%
#   filter(comuna_stringd <= 2) 
# 
# rol_df_planting <- rol_df_comuna %>%
#   filter(rptac_tipo == "regeneracion" |
#            rptac_tipo == "plantacion-suplementaria" |
#            rptac_tipo == "plantacion" 
#          | rptac_tipo == "enriquecimiento"
#   ) %>%
#   select(rptpro_id, ROL, rptpro_objetivo_manejo, rptro_id, rptpro_ano, rptpre_id, rptpre_comuna, Region, rptro_superficie, rptro_tipo_forestal, rptro_especie, rptac_ano_inicio, rptac_ano_fin, rptac_tipo, rptac_estado_desarrollo, rptac_monto_actividad, geometry) %>%
#   st_sf(sf_column_name = 'geometry') %>%
#   mutate(u_geom = st_equals(rol_df_planting))
# 
# tester_df <- rol_df_planting %>%
#   distinct()
# 

  
```


