---
title: "matched data impact evaluation"
author: "Albert Garcia"
date: "Feb 17, 2021"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
  \usepackage{booktabs}
  \usepackage[margin=1in]{geometry}
---

# Methods


## Why aggregate to property level?

## Why aggregate group-time treatment effects ex-post?

I use the difference-in-differences estimator proposed by Callaway and Santa'ana (2019) to mitigate concerns over issues surrounding the use of TWFE models in the presence of heterogeneous treatment effects. This amounts to first using a generalized propensity score method to better compare treatment and control units based on a set of covariates. Then, for each cohort, I compute the standard DID event study, before aggregating the group-time treatment effects with weights corresponding to each group's representativeness in the sample. This ensures that the weights for each group-time treatment effect are not negative, and therefore, do not risk reversing the sign of the treatment effect estimate.

# Results from matched data

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tinytex)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(rio)

library(did)



```


``` {r did , echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

enrolled_analysis_2r <- readRDS("enrolled_analysis_ratio2unique.rds")
enrolled_analysis_2r$Year <- as.numeric(enrolled_analysis_2r$Year)
enrolled_analysis_2r$id <- as.numeric(enrolled_analysis_2r$id)


did.enrolled_2r <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     #control_group = "notyettreated",
                     #est_method = my_did_panel,
                     xformla=~  forest + plantation + baresoil + pasture + urban +water+ slope +lat+  elev  + area_ha  +road_dist,
                     data=enrolled_analysis_2r, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

did.es <- aggte(did.enrolled_2r, type="dynamic", na.rm = TRUE, min_e=-12)#, max_e = 10)
ggdid(did.es)
did.ovr <- aggte(did.enrolled_2r, na.rm=TRUE, type = "simple")

ATT.overall <- data.frame("reg" = "all", "att.ovr" = did.ovr$overall.att, "se.ovr" = did.ovr$overall.se, "obs" = length(unique(enrolled_analysis_2r$id)), "nearest neighbors" = 2)

# plot the event study

dyn.es <- data.frame("att" = did.es$att.egt, "se" = did.es$se.egt, "e" = did.es$egt, "crit.val" = did.es$crit.val.egt)%>%
  mutate(period = ifelse(e >= 0 , "post", "pre"))

plot_2r <- ggplot(data=dyn.es, aes(x=e, y=att, color = period)) +
  geom_point() +
  geom_errorbar(aes(ymin=(att-crit.val*se), ymax=(att+crit.val*se)), width=0.1) +
  ggtitle("Event time treatment effects for all enrolled properties (r=2)") +
  xlab("years since property enrollment") + ylab("NDVI")+
  geom_hline(yintercept=0, linetype = "dashed")
plot_2r

#######
# 1 nearest neighbor dataset
enrolled_analysis_1r <- readRDS("enrolled_analysis_ratio1unique.rds")
enrolled_analysis_1r$Year <- as.numeric(enrolled_analysis_1r$Year)
enrolled_analysis_1r$id <- as.numeric(enrolled_analysis_1r$id)

did.enrolled_1r <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=enrolled_analysis_1r, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

did.es <- aggte(did.enrolled_1r, type="dynamic", na.rm = TRUE), min_e=-10)#, max_e = 10)
did.ovr <- aggte(did.enrolled_1r, na.rm=TRUE)

ATT.overall <- ATT.overall %>%
  rbind(data.frame("reg" = "all", "att.ovr" = did.ovr$overall.att, "se.ovr" = did.ovr$overall.se, "obs" = length(unique(enrolled_analysis_1r$id)), "nearest neighbors" = 1))

# plot the event study

dyn.es <- data.frame("att" = did.es$att.egt, "se" = did.es$se.egt, "e" = did.es$egt, "crit.val" = did.es$crit.val.egt)%>%
  mutate(period = ifelse(e >= 0 , "post", "pre"))

plot_1r <- ggplot(data=dyn.es, aes(x=e, y=att, color = period)) +
  geom_point() +
  geom_errorbar(aes(ymin=(att-crit.val*se), ymax=(att+crit.val*se)), width=0.1) +
  ggtitle("Event time treatment effects for all enrolled properties (r=1)") +
  xlab("years since property enrollment") + ylab("NDVI")
plot_1r


ggsave(plot = plot_2r,
       path = "figs",
  filename = "enrolled_dynamic_2r.png",
  width = 10,
  units = "in",
  dpi = 500)
plot_1r
plot_2r
```

```{r}

score_q1.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla= ~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==1)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q1_es <- aggte(score_q1.did, type="dynamic", na.rm = TRUE)

score_q2.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==2)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q2_es <- aggte(score_q2.did, type="dynamic", na.rm = TRUE)

score_q3.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==3)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q3_es <- aggte(score_q3.did, type="dynamic", na.rm = TRUE)

score_q4.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==4)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q4_es <- aggte(score_q4.did, type="dynamic", na.rm = TRUE)

```



