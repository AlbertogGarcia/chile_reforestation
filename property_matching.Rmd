---
title: "spatial join summary statistics"
author: "Albert Garcia"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tinytex)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(kableExtra)
library(stringdist)

source('crs_clean_fcn.R')
source('join_metrics.R')

```

``` {r NFL_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

setwd("C:/Users/garci/Desktop/chile_data/nativeforestlaw")

# xls files downloaded from CONAF
#projects
proyecto_1 <- read_excel("proyectos_1.xls")
proyecto_2 <- read_excel("proyectos_2.xls")
proyecto_df <- merge(proyecto_1, proyecto_2, by = c("rptpro_id", "rptpro_numero_ingreso"), all=TRUE)
#properties and coordinates
predio_df <- read_excel("predio.xls")
coordinadas_predio_df <- read_excel("coordinadas_predio.xls")
#owners
propietario_df <- read_excel("propietario.xls")
#stands
rodal_1 <- read_excel("rodal_1.xls")
rodal_2 <- read_excel("rodal_2.xls")
rodal_df <- merge(rodal_1, rodal_2, by = c("rptro_id"), all=TRUE)
#activities
actividades_1 <- read_excel("actividades_1.xls")
actividades_2 <- read_excel("actividades_2.xls")
actividades_df <- merge(actividades_1, actividades_2, by = c("rptac_id"), all=TRUE)
#fences
cercos_df <- read_excel("cerco.xls")

#merging into full data set
df_full <- proyecto_df %>%
  left_join(predio_df, by = c("rptpro_id", "rptpro_numero_ingreso")) %>%
  left_join(propietario_df, by = "rptpre_id") %>%
  left_join(coordinadas_predio_df, by = "rptpre_id") %>%
  left_join(rodal_df, by = "rptpre_id") %>%
  left_join(actividades_df, by = "rptro_id")


#northing easting huso datum
df_stand <- df_full %>%
  mutate(northing = 
           ifelse(is.na(rptro_norte), rptub_norte, rptro_norte)
         ) %>%
  mutate(easting = 
           ifelse(is.na(rptro_este), rptub_este, rptro_este)
         ) %>%
  mutate(datum = 
           ifelse(is.na(rptro_este) | is.na(rptro_norte), rptub_datum, rptro_datum)
         ) %>%
  mutate(huso = 
           ifelse(is.na(rptro_este) | is.na(rptro_norte), rptub_huso, rptro_huso)
         ) 

```


``` {r CIREN_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#uploading rural property cadastre shapefile
prop_rural.shp <- st_read(
  "C:/Users/garci/Desktop/chile_data/prop_rural/prop_rural.shp"
  )
# creating simple features object with rural properties shapefile
prop_rural.sf <- st_as_sf(prop_rural.shp) %>%
  st_transform(crs = "+proj=utm +zone=19 +south +ellps=aust_SA +units=m +no_defs")
```



``` {r projection cleaning, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

#using crs_clean_fcn to use common projection
new_df.sf <- crs_clean_fcn(df_stand) #outputs sf df with common projection (sad69 zone 19s)


# joining initial CIREN properties with cleaned NFL stand dataframe
df_joined <- prop_rural.sf %>%
  st_join(new_df.sf, join = st_intersects) %>%
  drop_na(rptpro_id)

```



``` {r fuzzy scoring, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

# We will create columns with measures of how close the match was
# variables for matching score:
### if rol matches exactly
### if rol is similar (matches on first part)
### string distance of property names
### proportion of properties that differ by less than a specified string distance

prop_rural_metrics <- join_metrics(df_joined)
  
by_region_table <- prop_rural_metrics %>%
  group_by(rptpre_region) %>%
  summarise(
    joined_projects = length(unique(rptpro_id)),
    joined_stands = length(rptpro_id), 
    rol_match = mean(rol_match),
    similar_rol = mean(partial_rol_match),
    stringd = mean(stringd, na.rm = TRUE),
    under20 = mean(under20, na.rm = TRUE)
    )
  

```



``` {r regions3_4_11_12 , echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#uploading rural property cadastre shapefile

reg3.shp<- st_read("C:/Users/garci/Desktop/Roles_sad69_19s/III_REGION/rroles_3.shp")
reg4.shp<- st_read("C:/Users/garci/Desktop/Roles_sad69_19s/IV_REGION/region_4.shp")
reg11.shp<- st_read("C:/Users/garci/Desktop/Roles_sad69_19s/XI_REGION/region_11.shp")
reg12.shp<- st_read("C:/Users/garci/Desktop/Roles_sad69_19s/XII_REGION/PREDIOS-MARZO2007.shp")

# creating simple features object with shapefile
reg3.sf <- st_as_sf(reg3.shp) %>%
  st_set_crs("+proj=utm +zone=19 +south +ellps=aust_SA +units=m +no_defs")
reg4.sf <- st_as_sf(reg4.shp) %>%
  st_set_crs("+proj=utm +zone=19 +south +ellps=aust_SA +units=m +no_defs")
reg11.sf <- st_as_sf(reg11.shp) %>%
  st_set_crs("+proj=utm +zone=19 +south +ellps=aust_SA +units=m +no_defs")
reg12.sf <- st_as_sf(reg12.shp) %>%
  st_set_crs("+proj=utm +zone=19 +south +ellps=aust_SA +units=m +no_defs")


reg12_joined <- reg12.sf %>%
  st_join(new_df.sf, join = st_intersects) %>%
  drop_na(rptpro_id) %>%
  rename(NOM_PREDIO = N_PREDIO)

reg12_metrics <- join_metrics(reg12_joined)

reg12_table <- reg12_metrics %>%
  summarise(
    joined_projects = length(unique(rptpro_id)),
    joined_stands = length(rptpro_id), 
    rol_match = mean(rol_match, na.rm = TRUE),
    similar_rol = mean(partial_rol_match, na.rm = TRUE),
    stringd = mean(stringd, na.rm = TRUE),
    under20 = mean(under20, na.rm = TRUE)
    )

reg12_table$region <- "Región de Magallanes y la Antártica Chilena"


reg11_joined <- reg11.sf %>%
  st_join(new_df.sf, join = st_intersects) %>%
  drop_na(rptpro_id) %>%
  rename(NOM_PREDIO = NOM_PREDI)

reg11_metrics <- join_metrics(reg11_joined)

reg11_table <- reg11_metrics %>%
  summarise(
    joined_projects = length(unique(rptpro_id)),
    joined_stands = length(rptpro_id), 
    rol_match = mean(rol_match, na.rm = TRUE),
    similar_rol = mean(partial_rol_match, na.rm = TRUE),
    stringd = mean(stringd, na.rm = TRUE),
    under20 = mean(under20, na.rm = TRUE)
    )

reg11_table$region <- "Región de Aysen del General Carlos Ibáñez del Campo"

reg3_joined <- reg3.sf %>%
  st_join(new_df.sf, join = st_intersects) %>%
  drop_na(rptpro_id)

reg3_metrics <- join_metrics(reg3_joined)

reg3_table <- reg3_metrics %>%
  summarise(
    joined_projects = length(unique(rptpro_id)),
    joined_stands = length(rptpro_id), 
    rol_match = mean(rol_match, na.rm = TRUE),
    similar_rol = mean(partial_rol_match, na.rm = TRUE),
    stringd = mean(stringd, na.rm = TRUE),
    under20 = mean(under20, na.rm = TRUE)
    )

reg3_table$region <- "Región de Atacama"


reg4_joined <- reg4.sf %>%
  st_join(new_df.sf, join = st_intersects) %>%
  drop_na(rptpro_id)

reg4_metrics <- join_metrics(reg4_joined)

reg4_table <- reg4_metrics %>%
  summarise(
    joined_projects = length(unique(rptpro_id)),
    joined_stands = length(rptpro_id), 
    rol_match = mean(rol_match, na.rm = TRUE),
    similar_rol = mean(partial_rol_match, na.rm = TRUE),
    stringd = mean(stringd, na.rm = TRUE),
    under20 = mean(under20, na.rm = TRUE)
    )
reg4_table$region <- "Región de Coquimbo"

reg3_table$geometry <- NULL
reg4_table$geometry <- NULL
reg11_table$geometry <- NULL
reg12_table$geometry <- NULL

newregions_table <- reg3_table %>%
  bind_rows(reg4_table) %>%
  bind_rows(reg11_table) %>%
  bind_rows(reg12_table)

by_region_table$geometry <- NULL
by_region_table = by_region_table[-1,]

by_region_summary <- by_region_table %>%
  mutate(region = rptpre_region) %>%
  select(- rptpre_region) %>%
  bind_rows(newregions_table)

```

 

``` {r NFLtotals, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

summary_tab <- df_stand %>%
  rename(region = rptpre_region)%>%
  group_by(region) %>%
  summarise(
    total_projects = length(unique(rptpro_id)),
    total_stands = length(rptpro_id)
    ) %>%
  left_join(by_region_summary, by = "region")
  


```


``` {r summary table, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

summary_tab1 <- summary_tab %>%
  select(region, total_projects, total_stands, joined_projects, joined_stands) %>%
  mutate(prop_joined_proj = joined_projects/total_projects)

summary_tab2 <- summary_tab %>%
  select(region, rol_match, similar_rol, stringd, under20)


kable(summary_tab1, 
      "latex", 
      booktabs =T, 
      caption = "spatial join metrics by region"
      ) %>%
  kable_styling(latex_options = "hold_position", font_size = 7) %>%
  row_spec(0, angle = 45)

kable(summary_tab2, 
      "latex", 
      booktabs =T, 
      caption = "spatial join metrics continued.."
      ) %>%
  kable_styling(latex_options = "hold_position", font_size = 7) %>%
  row_spec(0, angle = 45)

```



\begin{table}[h]
\caption{variable descriptions}
\begin{tabular}{|c|c|}
\hline
total\_projects & total Native Forest Law projects\\
total\_stands & total Native Forest Law stands\\
joined\_projects & Native Forest Law projects joined with CIREN properties\\
joined\_stands & Native Forest Law stands joined with CIREN properties\\
rol\_match & proportion of stands with matching rol id\\ 
similar\_rol & proportion of stands with matching first part of rol id\\
stringd & average string distance between property names from NFL stands and CIREN properties\\
under20 & proportion of joined property  names with string distance of less than 20\\
\hline
\end{tabular}
\end{table}


``` {r matching by rol, echo = FALSE, include = FALSE, eval = FALSE}

#here, I just see how many rols match between the CIREN data and native forest law data

#projects_df is the native forest law projects 
#prop_rural.sf is the CIRN data with the rols as simple features object
rol_df <- df_stand %>%
  rename(ROL = rptpre_rol) %>% #renaming rols to be the same in both datasets
  inner_join(prop_rural.sf, by = "ROL") #merge by rol


# just creating a df to display only a couple of choice variables
rol_display <- rol_df %>%
  select(ROL, NOM_PREDIO, rptpre_nombre)
rol_display$geometry <- NULL

kable(rol_display[1:20,], 
      "latex", 
      booktabs =T, 
      caption = "merged on rol dataframe"
      ) %>%
  kable_styling(latex_options = "hold_position", font_size = 6)

length(unique(rol_df$ROL)) #find number of unique rol numbers found

```



