---
title: "matching"
#author: "Albert Garcia"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads packages
library(latex2exp)
library(tidyverse)
library(ggplot2)
library(sf)
library(stringi)
library(data.table)
library(fuzzyjoin)
library(stringdist)

```

``` {r enrolled, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

rolarea_df <- readRDS("rolarea_df.rds")
property_df <- readRDS("property_df.rds")
rolarea_covars <- data.frame(readRDS("rolarea_covars.rds"))

```

```{r}
setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/treatment")

# load los rios ndvi time series for all ciren properties
temp = list.files(pattern="*.csv")
rolarea_ndvi = bind_rows(lapply(temp, read_csv))%>%
  select(prop_ID, year, mean) %>%
  distinct(prop_ID, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")# cast ndvi into wide format

enrolled_df <- rolarea_df %>%
  inner_join(rolarea_covars, by ="prop_ID")%>%
  inner_join(rolarea_ndvi, by = "prop_ID")

```

``` {r los rios match pool, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/match/losrios")
# load los rios ndvi time series for all ciren properties
temp = list.files(pattern="*.csv")
losrios_ndvi = bind_rows(lapply(temp, read_csv))%>%
  select(objectid, year, mean) %>%
  distinct(objectid, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")# cast ndvi into wide format

# to make sure I'm not selecting treated properties
# join los Rios CIREN properties with property df based on rol
losrios_matchpool <-  st_read(
  "/home/agarcia/chile_reforestation/input_data/PROPIEDADES_RURALES/LOS_RÍOS_CIREN_2018.shp"
  ) %>%
  mutate(desccomu = tolower(desccomu))%>%
  #anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"))%>%
  stringdist_anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"), method = "lv", max_dist = 1)%>%
  select("objectid", "rol")%>%
  inner_join(data.frame(readRDS("/home/agarcia/chile_reforestation/losrios_CIREN_covars.rds")), by = c("objectid", "rol"))%>%
  inner_join(losrios_ndvi, by = "objectid")
    
```

``` {r biobio ndvi, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/match/biobio")
# load biobio ndvi time series for all ciren properties
temp = list.files( pattern="*.csv")
biobio_ndvi = bind_rows(lapply(temp, read_csv))%>%
  #filter(objectid == 59515) %>%
  select(objectid, year, mean) %>%
  distinct(objectid, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")# cast ndvi into wide format

```

```{r}
setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/match/nuble")
# add nuble ndvi time series for all ciren properties
temp = list.files(pattern="*.csv")
biobionuble_ndvi = bind_rows(lapply(temp, read_csv))%>%
  select(objectid, year, mean) %>%
  distinct(objectid, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")%>%# cast ndvi into wide format%>%
bind_rows(biobio_ndvi)

# to make sure I'm not selecting treated properties
# join los Rios CIREN properties with property df based on rol
biobionuble_matchpool <-  st_read(
  "/home/agarcia/chile_reforestation/input_data/PROPIEDADES_RURALES/BIOBÍO_CIREN_2016.shp"
  ) %>%
  mutate(desccomu = tolower(desccomu))%>%
  #anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"))%>%
  stringdist_anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"), method = "lv", max_dist = 1)%>%
  select("objectid", "rol")%>%
  inner_join(data.frame(readRDS("/home/agarcia/chile_reforestation/biobionuble_CIREN_covars.rds")), by = c("objectid", "rol"))%>%
  inner_join(biobionuble_ndvi, by = "objectid")
    
```

``` {r maule, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/match/maule")
# load maule ndvi time series for all ciren properties
temp = list.files( pattern="*.csv")
maule_ndvi = bind_rows(lapply(temp, read_csv))%>%
  #filter(objectid == 59515) %>%
  select(objectid, year, mean) %>%
  distinct(objectid, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")# cast ndvi into wide format

# to make sure I'm not selecting treated properties
# join los Rios CIREN properties with property df based on rol
maule_matchpool <-  st_read(
  "/home/agarcia/chile_reforestation/input_data/PROPIEDADES_RURALES/MAULE_CIREN_2014.shp"
  ) %>%
  mutate(desccomu = tolower(desccomu))%>%
  #anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"))%>%
  stringdist_anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"), method = "lv", max_dist = 1)%>%
  select("objectid", "rol")%>%
  left_join(data.frame(readRDS("/home/agarcia/chile_reforestation/maule_CIREN_covars.rds")), by = c("objectid", "rol"))%>%
  inner_join(maule_ndvi, by = "objectid")
    
```

``` {r araucania, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}


setwd("/home/agarcia/chile_reforestation/input_data/new_CIREN_ndvi/match/araucania")
# load araucania ndvi time series for all ciren properties
temp = list.files( pattern="*.csv")
araucania_ndvi = bind_rows(lapply(temp, read_csv))%>%
  select(objectid, year, mean) %>%
  distinct(objectid, year, .keep_all = TRUE) %>%
  mutate(year = paste0("y_", year))%>%
  spread(key = "year", value = "mean")# cast ndvi into wide format

# to make sure I'm not selecting treated properties
# join los Rios CIREN properties with property df based on rol
araucania_matchpool <-  st_read(
  "/home/agarcia/chile_reforestation/input_data/PROPIEDADES_RURALES/ARAUCANÍA_CIREN_2013.shp"
  ) %>%
  mutate(desccomu = tolower(desccomu))%>%
  #anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"))%>%
  stringdist_anti_join(property_df, by = c(rol = "rptpre_rol", desccomu = "rptpre_comuna"), method = "lv", max_dist = 1)%>%
  select("objectid", "rol")%>%
  left_join(data.frame(readRDS("/home/agarcia/chile_reforestation/araucania_CIREN_covars.rds")), by = c("objectid", "rol"))%>%
  inner_join(araucania_ndvi, by = "objectid")
    
```

```{r}
# combining regional matchpools and treatedmatches
propertypaid_id <- readRDS("propertypaid_id.rds")

enrollees <- enrolled_df %>%
  mutate(treat = 1,
         forest = c_1,
         plantation = c_3,
         baresoil = c_10+c_12,
         pasture = c_9,
         water = c_15,
         urban = c_16,
         smallholder = ifelse(rptpro_tipo_concurso == "Otros Interesados", 0, 1))%>%
  select(rptpro_puntaje, smallholder, rptpro_tipo_concurso, rptpre_monto_total, rptpre_region, rptprop_sexo, prop_ID, first.treat, treated.later, rptprop_etnia, rptpro_objetivo_manejo.x, area_ha, reforestation2, reforestation, reffirst.treat, ref2first.treat, area_prop, road_dist, lat, long, slope, elev, treat, forest, plantation, water, baresoil, pasture, urban, y_2005, y_2006, y_2007, y_2008, y_2009, y_2010, y_2011, y_2012, y_2013, y_2014, y_2015, y_2016, y_2017, y_2018, y_2019, y_2020)%>%
  left_join(propertypaid_id, by = "prop_ID")%>%
  mutate(paid = ifelse(is.na(paid), 0, paid))

summary(enrollees$paid)

all_matchpool <- data.frame(losrios_matchpool) %>%
  bind_rows(maule_matchpool)%>%
  bind_rows(araucania_matchpool)%>%
  bind_rows(biobionuble_matchpool)%>%
  mutate(treat=0,
         first.treat = 0,
         forest = c_1,
         plantation = c_3,
         baresoil = c_12,+c_10,
         pasture = c_9,
         water = c_15,
         urban = c_16)%>%
  select(objectid, treat, first.treat, area_ha, road_dist, lat, long, slope, elev, treat, forest, plantation, water, baresoil, pasture, urban, y_2005, y_2006, y_2007, y_2008, y_2009, y_2010, y_2011, y_2012, y_2013, y_2014, y_2015, y_2016, y_2017, y_2018, y_2019, y_2020)


df <- data.frame(enrollees)%>%
  bind_rows(all_matchpool)%>%
  mutate(trend1918 = y_2019 - y_2018,
         trend1817 = y_2018 - y_2017,
         trend1716 = y_2017 - y_2016,
         trend1615 = y_2016 - y_2015,
         trend1514 = y_2015 - y_2014,
         trend1413 = y_2014 - y_2013,
         trend1312 = y_2013 - y_2012,
         trend1211 = y_2012 - y_2011,
         trend1110 = y_2011 - y_2010,
         trend1009 = y_2010 - y_2009,
         trend0908 = y_2009 - y_2008,
         trend0807 = y_2008 - y_2007,
         trend0706 = y_2007 - y_2006,
         trend0605 = y_2006 - y_2005,
         road_dist = unlist(road_dist))
library(rio)
export(df, "matching_df.rds")


```

```{r paid and unpaid}
library(MatchIt)
# create matched dataframes

df <- df %>%
  drop_na(elev, slope)
  

matched_2009 <- matchit(treat ~ trend0807 + trend0706 + trend0605 + y_2007 +
                          forest + plantation + baresoil + pasture + urban +water + slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2009),
                 method = "nearest")
# 
# summary(matched_2009, un = FALSE)
# 
#love.plot(matched_2009, thresholds = c(m = .25))



matched_2010 <- matchit(treat ~ trend0908 + trend0807 + trend0706 + trend0605 + y_2008+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2010),
                 method = "nearest")

matched_2011 <- matchit(treat ~ trend1009 + trend0908 + trend0807 + trend0706 + y_2009 + 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2011),
                 method = "nearest")

matched_2012 <- matchit(treat ~ trend1110 + trend1009 + trend0908 + trend0807 + y_2010 + 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2012),
                 method = "nearest")

matched_2013 <- matchit(treat ~ trend1211 + trend1110 + trend1009 + trend0908 + y_2011+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2013),
                 method = "nearest")

matched_2014 <- matchit(treat ~ trend1312 + trend1211 + trend1110 + trend1009 + y_2012 + 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2014),
                 method = "nearest")

matched_2015 <- matchit(treat ~ trend1413 + trend1312 + trend1211 + trend1110  + y_2013+ 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2015),
                 method = "nearest")

matched_2016 <- matchit(treat ~ trend1514 + trend1413 + trend1312 + trend1211 +  y_2014+ 
                          forest + plantation + baresoil + pasture +urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2016),
                 method = "nearest")

matched_2017 <- matchit(treat ~ trend1615 + trend1514 + trend1413 + trend1312 +  y_2015+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2017),
                 method = "nearest")

matched_2018 <- matchit(treat ~ trend1716 + trend1615 + trend1514 + trend1413  +  y_2016+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2018),
                 method = "nearest")

matched_2019 <- matchit(treat ~ trend1817 + trend1716 + trend1615 + trend1514 +  y_2017+ 
                          forest + plantation + baresoil + pasture+ urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df, first.treat == 0 | first.treat == 2019),
                 method = "nearest")

map_covars <- function(df){
  return_df <- df %>%
    group_by(subclass)%>%
    mutate(smallholder = max(smallholder, na.rm = TRUE),
         reforestation = max(reforestation, na.rm = TRUE),
         reforestation2 = max(reforestation2, na.rm = TRUE),
         area_prop = max(area_prop, na.rm = TRUE),
         did_group = max(first.treat, na.rm = TRUE)
         )%>%
    ungroup()
 return(return_df)
}

# group by matched pairs
matched_wide <- map_covars(match.data(matched_2009, subclass = "subclass"))%>%
  bind_rows(map_covars(match.data(matched_2010, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2011, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2012, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2013, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2014, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2015, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2016, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2017, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2018, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2019, subclass = "subclass")))%>%
  mutate(id = 1:nrow(.))

baltest_covs <- subset(matched_wide, select = c("forest" ,"plantation" , "baresoil", "pasture", "urban", "water", "slope", "elev", "area_ha", "road_dist"))

bal.tab(baltest_covs, treat = matched_wide$treat,thresholds = c(m = .25))

matched_long <- gather(matched_wide, "Year", "NDVI", y_2005:y_2020)%>%
  separate(Year, , into = c(NA, "Year"), sep = "_")

export(matched_long, "enrolled_analysis.rds")



length(unique(matched_long$id))
length(unique(df_matched$id))

# covariates to impose on matches: contest type, reforestation, reforestation2, payment, area_diff
# can use max on all except for contest type which.max(nchar(rptpro_tipo_concurso))


# recombine matched dataframes
```

```{r paid only}
library(MatchIt)
# create matched dataframes

df_paid <- df %>%
  drop_na(elev, slope)%>%
  filter(paid == 1 | is.na(paid))
  

pmatched_2009 <- matchit(treat ~ trend0807 + trend0706 + trend0605 + y_2007 +
                          forest + plantation + baresoil + pasture + urban +water + slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2009),
                 method = "nearest")

pmatched_2010 <- matchit(treat ~ trend0908 + trend0807 + trend0706 + trend0605 + y_2008+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2010),
                 method = "nearest")

pmatched_2011 <- matchit(treat ~ trend1009 + trend0908 + trend0807 + trend0706 + y_2009 + 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2011),
                 method = "nearest")

pmatched_2012 <- matchit(treat ~ trend1110 + trend1009 + trend0908 + trend0807 + y_2010 + 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2012),
                 method = "nearest")

pmatched_2013 <- matchit(treat ~ trend1211 + trend1110 + trend1009 + trend0908 + y_2011+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2013),
                 method = "nearest")

pmatched_2014 <- matchit(treat ~ trend1312 + trend1211 + trend1110 + trend1009 + y_2012 + 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2014),
                 method = "nearest")

pmatched_2015 <- matchit(treat ~ trend1413 + trend1312 + trend1211 + trend1110  + y_2013+ 
                          forest + plantation + baresoil + pasture  + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2015),
                 method = "nearest")

pmatched_2016 <- matchit(treat ~ trend1514 + trend1413 + trend1312 + trend1211 +  y_2014+ 
                          forest + plantation + baresoil + pasture +urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2016),
                 method = "nearest")

pmatched_2017 <- matchit(treat ~ trend1615 + trend1514 + trend1413 + trend1312 +  y_2015+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2017),
                 method = "nearest")

pmatched_2018 <- matchit(treat ~ trend1716 + trend1615 + trend1514 + trend1413  +  y_2016+ 
                          forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2018),
                 method = "nearest")

pmatched_2019 <- matchit(treat ~ trend1817 + trend1716 + trend1615 + trend1514 +  y_2017+ 
                          forest + plantation + baresoil + pasture+ urban +water+ slope + elev  + area_ha + road_dist, 
                   data = subset(df_paid, first.treat == 0 | first.treat == 2019),
                 method = "nearest")

map_covars <- function(df){
  return_df <- df %>%
    group_by(subclass)%>%
    mutate(smallholder = max(smallholder, na.rm = TRUE),
         reforestation = max(reforestation, na.rm = TRUE),
         reforestation2 = max(reforestation2, na.rm = TRUE),
         area_prop = max(area_prop, na.rm = TRUE),
         did_group = max(first.treat, na.rm = TRUE)
         )%>%
    ungroup()
 return(return_df)
}

# group by matched pairs
pmatched_wide <- map_covars(match.data(pmatched_2009, subclass = "subclass"))%>%
  bind_rows(map_covars(match.data(pmatched_2010, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2011, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2012, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2013, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2014, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2015, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2016, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2017, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2018, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(pmatched_2019, subclass = "subclass")))%>%
  mutate(id = 1:nrow(.))

pbaltest_covs <- subset(pmatched_wide, select = c("forest" ,"plantation" , "baresoil", "pasture", "urban", "water", "slope", "elev", "area_ha", "road_dist"))

bal.tab(baltest_covs, treat = pmatched_wide$treat,thresholds = c(m = .25))

pmatched_long <- gather(pmatched_wide, "Year", "NDVI", y_2005:y_2020)%>%
  separate(Year, , into = c(NA, "Year"), sep = "_")

export(pmatched_long, "paid_analysis.rds")


```

