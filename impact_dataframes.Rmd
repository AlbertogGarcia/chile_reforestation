---
title: "building native forest law impact dataframes"
#author: "Albert Garcia"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(kableExtra)
library(stringdist)
library(GADMTools)
library(lwgeom)
library(units)
library(fuzzyjoin)
library(Metrics)
library(DataCombine)
library(Hmisc)

```

``` {r NFL_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

setwd("C:/Users/garci/Dropbox/chile_reforestation/external_data")

library(readxl)

# xls files downloaded from CONAF
#projects
proyecto2_df <- read.csv("concurso_conaf/ConcursoLeyBosqueNativo_proyecto.csv")
proyecto_df <- read_xlsx("concurso_conaf/proyecto.xlsx")

#properties and coordinates
#predio_df <- read.csv("concurso_conaf/ConcursoLeyBosqueNativo_predio.csv")
predio_df <- read_xlsx("concurso_conaf/predio.xlsx")
#owners
#propietario_df <- read.csv("concurso_conaf/ConcursoLeyBosqueNativo_propietario.csv")
propietario_df <- read_xlsx("concurso_conaf/propietario.xlsx")
#stands
#rodal_df <- read.csv("concurso_conaf/ConcursoLeyBosqueNativo_rodal.csv")
rodal_df <- read_xlsx("concurso_conaf/rodal.xlsx")
#activities
#actividades_df <- read.csv("concurso_conaf/ConcursoLeyBosqueNativo_actividad.csv")
actividades_df <- read_xlsx("concurso_conaf/actividad.xlsx")

coordinadas_df <- read_xlsx("concurso_conaf/coordinadas_predio.xlsx")
```

```{r}
#merging into dataframe of all properties and owners
property_df <- proyecto_df %>%
  full_join(predio_df, by = "rptpro_id") %>%
  full_join(propietario_df, by = "rptpre_id")%>%
  #mutate(prop_ID = group_indices(., rptpre_rol, rptpre_comuna, rptpro_numero_region))%>%
  group_by(rptpre_id) %>%
  #arrange(rptpro_ano, .by_group = TRUE)%>%
  #distinct(rptpro_id, .keep_all = TRUE) %>%
  mutate(#cum_bonusarea = cumsum(rptpro_superficie),
         #cum_monto = cumsum(rptpro_monto_total),
         first.treat = min(rptpro_ano),
         latest.treat = max(rptpro_ano),
         treated.later = ifelse( first.treat != latest.treat, 1, 0))%>%
  ungroup()

full_df <- property_df %>%
  left_join(rodal_df, by = "rptpre_id") %>%
  left_join(actividades_df, by = "rptro_id")

submitted_plan <- full_df %>%
  filter(rptpro_tiene_bonificacion_saff == "Si" | rptpro_tiene_bonificacion_saff=="Si" )

# 9078 unique properties

#merging into full data set
activity_df <- property_df %>%
  left_join(rodal_df, by = "rptpre_id") %>%
  left_join(actividades_df, by = "rptro_id") %>%
  dcast(rptpre_id#prop_ID +
          #rptpre_rol + rptpro_objetivo_manejo + rptpre_comuna 
        + rptpro_ano
        ~ rptac_tipo, 
        fun.aggregate = function(x){as.integer(length(x) > 0)})%>%
  group_by(rptpre_id)%>%
  mutate(reforestation = ifelse(plantacion == 1 | `plantacion-suplementaria`==1 | regeneracion==1 , 1, 0),
         reforestation2 = ifelse(plantacion == 1 | `plantacion-suplementaria`==1 | regeneracion==1 |`corta-regeneracion`==1, 1, 0),
         ref_indicyr = ifelse(reforestation ==1 , rptpro_ano, NA),
         ref2_indicyr = ifelse(reforestation2 ==1 , rptpro_ano, NA),
         reffirst.treat = ifelse(reforestation ==1, min(ref_indicyr), NA),
         ref2first.treat = ifelse(reforestation2 ==1, min(ref2_indicyr), NA)
         )%>%
  ungroup()%>%
  select(-c(ref_indicyr, ref2_indicyr))

# fcn to remove accents
accents <- function(x){
  x <- stri_trans_general(x, id = "Latin-ASCII")
}

NFL_df <- property_df %>%
  left_join(activity_df, by = c("rptpre_rol" , "rptpre_comuna" , "rptpro_ano"))%>%
  mutate(rptpre_comuna = tolower(accents(rptpre_comuna)))

submitted_mp <- property_df %>%
  filter(rptpro_tiene_plan_saff == "Si" | rptpro_tiene_bonificacion_saff == "Si")%>%
  left_join(activity_df, by = c("rptpre_id", "rptpro_ano"))%>%
  mutate(rptpre_comuna = tolower(accents(rptpre_comuna)))%>%
  separate(rptpre_rol, into = c("rol1", "rol2"), sep = "-", remove=FALSE)%>%
  mutate(rol1 = str_remove(rol1, "^0+"),
         rol2 = str_remove(rol2, "^0+"))%>%
  unite("rptpre_rol", rol1, rol2, sep="-")


library(rio)
 #export(NFL_df, "NFL_df.rds")
  
  

```

```{r scraped CIREN_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
setwd("C:/Users/garci/Dropbox/chile_reforestation/external_data/ciren_simef")

file_list <- list.files("PROPIEDADES_RURALES", pattern = "*shp", full.names = TRUE)
shapefile_list <- lapply(file_list, read_sf)

propiedadesrurales <- sf::st_as_sf(bind_rows(shapefile_list)) %>%
  rename(rptpre_rol = rol)%>%
  mutate(area_ha = as.numeric(units::set_units(st_area(.), ha)))%>%
  select(desccomu, rptpre_rol, area_ha)

class(propiedadesrurales)

```

```{r original CIREN_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
# setwd("C:/Users/garci/Desktop/chile_data/prop_rural")

# fcn to remove accents

prop_rural <- st_read(
  "C:/Users/garci/Desktop/UCSB/chile_data/prop_rural/prop_rural.shp"
  )%>%
  rename(rptpre_rol = ROL, desccomu = DESCCOMU)%>%
  st_transform(crs = st_crs(propiedadesrurales))%>%
  mutate(area_ha = as.numeric(units::set_units(st_area(.), ha)),
         desccomu = tolower(accents(desccomu)))
  
# prop_rural1 <- prop_rural %>%
#   separate(rptpre_rol, into = c("rol1", "rol2"), sep = "-", remove=FALSE)%>%
#   mutate(rol1 = str_remove(rol1, "^0+"),
#          rol2 = str_remove(rol2, "^0+"))%>%
#   unite("rptpre_rol", rol1, rol2, sep="-")

all_rural_props <- prop_rural %>%  
  select(desccomu, rptpre_rol, area_ha) %>%
  rbind(propiedadesrurales)%>%
  mutate(desccomu = tolower(accents(desccomu)))

```

```{r CIREN_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

# rolarea_df <- all_rural_props %>%
#   merge(NFL_df, by = "rptpre_rol", all = TRUE) %>%
#   mutate(comuna_stringd = stringdist(rptpre_comuna, desccomu, method = "dl")) %>%
#   filter(comuna_stringd <= 1) %>%
#   group_by(prop_ID) %>%
#   mutate(area_diff = abs(area_ha-rptpre_superficie_predial),
#          good_ranks = order(order(area_diff, decreasing=FALSE)),
#          area_prop = area_diff/rptpre_superficie_predial,
#          treat = 1) %>%
#   ungroup()%>%
#   filter(good_ranks ==1 )#& area_prop < 1/3)
# #%>%st_sf(sf_column_name = 'geometry')
#   
# class(rolarea_df)
# 
# rolarea_geoms <- rolarea_df %>%
#   select(prop_ID)%>%
#   distinct(prop_ID)
# 
# class(rolarea_geoms)
# 
# #st_write(rolarea_geoms, dsn = "rolarea_geoms.shp", driver = "ESRI Shapefile")
# library(rio)
# export(rolarea_df, "rolarea_df.rds")

submitted_rol <- all_rural_props %>%
  inner_join(submitted_mp, by = "rptpre_rol")%>%
  mutate(comuna_stringd = stringdist(rptpre_comuna, desccomu, method = "dl")) %>%
  filter(comuna_stringd <= 1) %>%
  group_by(rptpre_id) %>%
  mutate(area_diff = abs(area_ha-rptpre_superficie_predial),
         area_prop = area_diff/rptpre_superficie_predial,
         treat = 1) %>%
  filter(area_diff == min(area_diff))%>%
  ungroup()%>%
  distinct(.keep_all = TRUE)%>%
  select(-comuna_stringd)

submittedmp_rol <- prop_rural %>%
  merge(submitted_mp, by = "rptpre_rol", all = TRUE) %>%
  mutate(comuna_stringd = stringdist(rptpre_comuna, desccomu, method = "dl")) %>%
  filter(between(comuna_stringd, 2, 3)) %>%
  mutate(area_diff = abs(area_ha-rptpre_superficie_predial),
         area_prop = area_diff/rptpre_superficie_predial,
         treat = 1)%>%
  group_by(rptpre_id)%>%
  filter(area_prop<.5 & area_diff==min(area_diff) &(area_prop <.25 | comuna_stringd <3))%>%
  ungroup()%>%
  select(colnames(submitted_rol))%>%
  rbind(submitted_rol)

# 
# st_write(submitted_geoms, dsn = "submitted_geoms.shp", driver = "ESRI Shapefile")
# library(rio)
# export(submitted_rol, "submitted_rol.rds")
```

```{r}
# missed_submitted <- submitted_mp %>%
#   anti_join(submittedmp_rol, by = c("rptpre_id")) 

submitted_coordinadas <- submitted_mp %>%
  left_join(coordinadas_df, by = "rptpre_id")%>%
  left_join(rodal_df, by = "rptpre_id")%>%
  mutate(datum = ifelse(is.na(rptro_datum), rptub_datum, rptro_datum),
         easting = ifelse(is.na(rptro_este), rptub_este, rptro_este),
         northing = ifelse(is.na(rptro_norte), rptub_norte, rptro_norte),
         huso = ifelse(is.na(rptro_huso), rptub_huso, rptro_huso))%>%
  #select(rptpre_id, huso, datum, easting, northing, rptpre_rol, rptpre_comuna, rptpre_nombre, rptprop_nombre, rptpre_superficie_predial)%>%
  crs_clean_fcn(.)%>%
  st_transform(crs = st_crs(all_rural_props))

submitted_spatialmatch <- all_rural_props %>%
  st_join(submitted_coordinadas)%>%
  #drop_na(area_ha)%>%
  mutate(area_diff = abs(area_ha-rptpre_superficie_predial),
         area_prop = area_diff/rptpre_superficie_predial,
         treat = 1
         # NOM_PREDIO = tolower(accents(NOM_PREDIO)),
         # rptpre_nombre = tolower(accents(rptpre_nombre)),
         # predio_stringd = stringdist(rptpre_nombre, NOM_PREDIO, method = "dl")
         )%>%
  group_by(rptpre_id)%>%
  filter(area_diff==min(area_diff) )%>%
  rename(rptpre_rol = rptpre_rol.y)%>%
  select(colnames(submittedmp_rol))

mgmtplan_df <- rbind(submitted_spatialmatch, submittedmp_rol)%>%
  group_by(rptpre_id)%>%
  filter(area_diff==min(area_diff) )%>%
  distinct(rptpre_id, .keep_all = TRUE)%>%
  group_by(rptpre_rol, rptpre_comuna, rptpre_region)%>%
  mutate(prop_ID = cur_group_id())

mgmtplan_geoms <- mgmtplan_df %>%
  distinct(prop_ID, .keep_all = TRUE)%>%
  select(prop_ID)
st_write(mgmtplan_geoms, dsn = "mgmtplan_geoms.shp", driver = "ESRI Shapefile")
# library(rio)
export(mgmtplan_df, "mgmtplan_df.rds")

```
