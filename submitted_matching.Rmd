---
title: "matching"
#author: "Albert Garcia"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads packages
library(latex2exp)
library(tidyverse)
library(ggplot2)
library(sf)
library(stringi)
library(data.table)
library(fuzzyjoin)
library(stringdist)
library(kableExtra)

```

```{r}

NFL_df <- readRDS("C:/Users/garci/Dropbox/chile_reforestation/data/submittedmp_analysis/NFL_df.rds")
#property_df <- readRDS("property_df.rds")
all_matchpool <- data.frame(readRDS("C:/Users/garci/Dropbox/chile_reforestation/data/submittedmp_analysis/all_matchpool.rds"))
my_match <- data.frame(readRDS("C:/Users/garci/Dropbox/chile_reforestation/data/submittedmp_analysis/my_match.rds"))

# native_df <- NFL_df %>%
#   mutate(submitted_mp = ifelse( rptpro_tiene_plan_saff!="No", 1, 0))%>%
#   distinct(prop_ID, submitted_mp, .keep_all = TRUE)

# follow_thru <- my_match %>%
#   inner_join(native_df, by = "prop_ID")%>%
#   mutate(treat=1,
#          forest = c_1,
#          plantation = c_3,
#          baresoil = c_12,+c_10,
#          pasture = c_9,
#          shrub = c_5,
#          water = c_15,
#          urban = c_16,
#          plantation2 = plantation*area_ha)%>%
#   filter(area_diff<100)%>%
#   drop_na(submitted_mp)
# 
# mod <- lm(submitted_mp ~  as.factor(rptprop_etnia) + as.factor(rptpro_objetivo_manejo) + as.factor(rptpro_tipo_concurso) + as.factor(rptpro_ano) + rptpro_monto_total + rptpre_superficie_predial+rptpre_superficie_bonificada + as.factor(rptpro_tipo_presenta)+as.factor(rptpre_region), data = native_df)
# summary(mod)
# 
# mod2 <- lm(submitted_mp ~  plantation, data = follow_thru)
# summary(mod2)
# mod2 <- lm(submitted_mp ~  pasture, data = follow_thru)
# summary(mod2)

```

```{r}
# combining regional matchpools and treatedmatches
native_forest_df <- NFL_df %>%
  filter(rptpro_tiene_bonificacion_saff=="Si" | rptpro_tiene_plan_saff == "Si" | rptpro_numero_bonos >0)

sumbit_ids <- native_forest_df %>%
  group_by(prop_ID)%>%
  mutate(first.treat = min(rptpro_ano),
         smallholder = ifelse(rptpro_tipo_concurso != "Otros Interesados", 1, 0))%>%
  select(prop_ID, first.treat, smallholder) %>%
  distinct(prop_ID, .keep_all = TRUE)

my_submitted_match <- my_match %>%
  inner_join(sumbit_ids, by = "prop_ID")%>%
  mutate(treat=1,
         forest = c_1,
         plantation = c_3,
         baresoil = c_12,
         pasture = c_9,
         shrub = c_5,
         water = c_15,
         urban = c_16)

df <- data.frame(my_submitted_match)%>%
  bind_rows(all_matchpool)%>%
  mutate(trend1918 = y_2019 - y_2018,
         trend1817 = y_2018 - y_2017,
         trend1716 = y_2017 - y_2016,
         trend1615 = y_2016 - y_2015,
         trend1514 = y_2015 - y_2014,
         trend1413 = y_2014 - y_2013,
         trend1312 = y_2013 - y_2012,
         trend1211 = y_2012 - y_2011,
         trend1110 = y_2011 - y_2010,
         trend1009 = y_2010 - y_2009,
         trend0908 = y_2009 - y_2008,
         trend0807 = y_2008 - y_2007,
         trend0706 = y_2007 - y_2006,
         trend0605 = y_2006 - y_2005,
         evi_trend1918 = evi_2019 - evi_2018,
         evi_trend1817 = evi_2018 - evi_2017,
         evi_trend1716 = evi_2017 - evi_2016,
         evi_trend1615 = evi_2016 - evi_2015,
         evi_trend1514 = evi_2015 - evi_2014,
         evi_trend1413 = evi_2014 - evi_2013,
         evi_trend1312 = evi_2013 - evi_2012,
         evi_trend1211 = evi_2012 - evi_2011,
         evi_trend1110 = evi_2011 - evi_2010,
         evi_trend1009 = evi_2010 - evi_2009,
         evi_trend0908 = evi_2009 - evi_2008,
         evi_trend0807 = evi_2008 - evi_2007,
         evi_trend0706 = evi_2007 - evi_2006,
         evi_trend0605 = evi_2006 - evi_2005,
         road_dist = unlist(road_dist))%>%
  mutate(id = 1:nrow(.))
library(rio)
export(df, "matching_df.rds")



```

```{r}

# create matched dataframes
df <- readRDS("matching_df.rds")
```

```{r}
library(MatchIt)
df <- df %>%
  drop_na(elev, slope)
  
#love.plot(matched_2009, thresholds = c(m = .25))

r=2



matched_2009 <- matchit(treat ~ evi_trend0807 + evi_trend0706 + evi_trend0605 + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2009),
                 method = "nearest", ratio = r)

matched_2010 <- matchit(treat ~ evi_trend0908 + evi_trend0807 + evi_trend0706  + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2010),
                 method = "nearest", ratio = r)

matched_2011 <- matchit(treat ~ evi_trend1009 + evi_trend0908 + evi_trend0807 + evi_trend0706 + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2011),
                 method = "nearest", ratio = r)

matched_2012 <- matchit(treat ~ evi_trend1110 + evi_trend1009 + evi_trend0908 + evi_trend0807+ evi_trend0706 +evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2012),
                 method = "nearest", ratio = r)

matched_2013 <- matchit(treat ~ evi_trend1211 + evi_trend1110 + evi_trend1009 + evi_trend0908 + evi_trend0807+ evi_trend0706 + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2013),
                 method = "nearest", ratio = r)

matched_2014 <- matchit(treat ~ evi_trend1312 + evi_trend1211 + evi_trend1110 + evi_trend1009 + evi_trend0908+ evi_trend0807+ evi_trend0706 + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2014),
                 method = "nearest", ratio = r)

matched_2015 <- matchit(treat ~ evi_trend1413 + evi_trend1312 + evi_trend1211 + evi_trend1110 + evi_trend1009 + evi_trend0908+ evi_trend0807+ evi_trend0706 + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2015),
                 method = "nearest", ratio = r)

matched_2016 <- matchit(treat ~ evi_trend1514 + evi_trend1413 + evi_trend1312 + evi_trend1211 + evi_trend1110+ evi_trend1009 + evi_trend0908+ evi_trend0807+ evi_trend0706 + evi_trend0605
                        +  evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2016),
                 method = "nearest", ratio = r)

matched_2017 <- matchit(treat ~ evi_trend1615 + evi_trend1514 + evi_trend1413 + evi_trend1312 + evi_trend1211+ evi_trend1110+ evi_trend1009 + evi_trend0908+ evi_trend0807+ evi_trend0706 + evi_trend0605
                        +  evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2017),
                 method = "nearest", ratio = r)

matched_2018 <- matchit(treat ~ evi_trend1716 + evi_trend1615 + evi_trend1514 + evi_trend1413 + evi_trend1312 + evi_trend1211+ evi_trend1110+ evi_trend1009 + evi_trend0908+evi_trend0807+ evi_trend0706 +evi_trend0605
                        +  evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2018),
                 method = "nearest", ratio = r)

matched_2019 <- matchit(treat ~ evi_trend1817 + evi_trend1716 + evi_trend1615 + evi_trend1514 + evi_trend1413 + evi_trend1312 + evi_trend1211+ evi_trend1110+ evi_trend1009 + evi_trend0908+evi_trend0807+ evi_trend0706 + evi_trend0605
                        + evi_2007
                        + forest + plantation + baresoil + pasture + shrub + urban +water + slope + elev + lat +long + area_ha + road_dist,
                   data = subset(df, first.treat == 0 | first.treat == 2019),
                 method = "nearest", ratio = r)


map_covars <- function(df){
  # return_df <- within(df, quartile <- as.integer(cut(rptpro_puntaje, quantile(rptpro_puntaje, probs=0:4/4, na.rm = TRUE), include.lowest=TRUE)))
  
    return_df <- df %>%
    group_by(subclass)%>%
    mutate(smallholder = max(smallholder, na.rm = TRUE)
         #quartile = max(quartile, na.rm = TRUE)
         )%>%
    ungroup()
  
 return(return_df)
}


# group by matched pairs
matched_wide <- map_covars(match.data(matched_2009, subclass = "subclass"))%>%
  bind_rows(map_covars(match.data(matched_2010, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2011, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2012, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2013, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2014, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2015, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2016, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2017, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2018, subclass = "subclass")))%>%
  bind_rows(map_covars(match.data(matched_2019, subclass = "subclass")))%>%
  distinct(id, .keep_all = TRUE)

export(matched_wide, "matched_wide.rds")

# ndvi_year_vars <- c("y_2005", "y_2006", "y_2007", "y_2008", "y_2009", "y_2010", "y_2011", "y_2012", "y_2013", "y_2014", "y_2015", "y_2016", "y_2017", "y_2018", "y_2019", "y_2020")
# 
# evi_year_vars <- c("evi_2005", "evi_2006", "evi_2007", "evi_2008", "evi_2009", "evi_2010", "evi_2011", "evi_2012", "evi_2013", "evi_2014", "evi_2015", "evi_2016", "evi_2017", "evi_2018", "evi_2019", "evi_2020")
# 
# id_vars <- c("id", "smallholder", "forest", "plantation" , "baresoil" , "shrub", "pasture" , "urban", "water", "slope" , "elev"  , "area_ha" , "road_dist", "lat", "long", "treat", "first.treat" )
# 
# m_long <- melt(matched_wide, id.vars = id_vars,  variable.name = c("Year"), value.name = c("EVI2"), measure.vars = evi_year_vars) %>%
#   separate(Year, into = c(NA, "Year"), sep = "_")

```

```{r}


# control_matches <- matched_wide %>%
#   drop_na(controlid)%>%
#   select(controlid)
# 
# control_geoms <- all_matchpool %>%
#   inner_join(control_matches, by = "controlid")%>%
#   select(controlid)
# 
# st_write(control_geoms, dsn = "control_geoms.shp", driver = "ESRI Shapefile")
  

```

```{r}
# setwd("C:/Users/garci/Dropbox/chile_reforestation/data/property_ndvi/new_CIREN_ndvi/control_evi")
# 
# # load evi time series for all matched properties
# temp = list.files(pattern="*.csv")
# control_evi = bind_rows(lapply(temp, read_csv))%>%
#   select(controlid, year, mean) %>%
#   distinct(controlid, year, .keep_all = TRUE) %>%
#   rename(evi2 = mean,
#          Year=year)

```

```{r}
# setwd("C:/Users/garci/Dropbox/chile_reforestation/data/property_ndvi/new_CIREN_ndvi/enrolled/evi2")
# 
# # load evi time series for all matched properties
# temp = list.files(pattern="*.csv")
# treat_evi = bind_rows(lapply(temp, read_csv))%>%
#   select(prop_ID, year, mean) %>%
#   distinct(prop_ID, year, .keep_all = TRUE) %>%
#   rename(evi2 = mean,
#          Year=year)

```



```{r}

control_wide <- subset(matched_wide, treat!=1)
control_long <- gather(control_wide, "Year", "EVI2", evi_2005:evi_2020)%>%
  separate(Year, into = c(NA, "Year"), sep = "_") %>%
  mutate(Year= as.numeric(Year))


treat_wide <- subset(matched_wide, treat==1)
treat_long <- treat_wide %>%
  inner_join(native_forest_df, by = "prop_ID")%>%
  group_by(id)%>%
  mutate(first.treat = min(rptpro_ano))%>%
  ungroup()%>%
  gather(., "Year", "EVI2", evi_2005:evi_2020)%>%
  separate(Year, into = c(NA, "Year"), sep = "_")%>%
  group_by(id, rptpro_ano, Year)%>%
  mutate(temp_id = row_number()) %>%
  filter(temp_id == 1) %>%
  select(-temp_id)%>%
  ungroup()%>%
  group_by(id) %>%
  arrange(Year, rptpro_ano, .by_group = TRUE)%>%
  mutate(new_treated_area = ifelse(rptpro_ano == Year , rptpro_superficie, 0),
         new_monto = ifelse(rptpro_ano == Year , rptpro_monto_total, 0),
         cum_bonusarea = cumsum(new_treated_area),
         cum_monto = cumsum(new_monto)
  )%>%
  ungroup()%>%
  group_by(id, Year)%>%
  filter(cum_monto == max(cum_monto))%>%
  mutate(temp_id = row_number()) %>% 
  filter(temp_id == 1) %>% 
  select(-temp_id, -new_monto, -new_treated_area,-rptpro_ano)%>%
  ungroup()%>%
  mutate(Year= as.numeric(Year))
  
matched_long <- bind_rows(control_long, treat_long)

export(matched_long, "mgmtplan_analysis.rds")

```



```{r}

dta <- matched_long %>%
  mutate(G = first.treat,
         period = Year,
         Y = NDVI)
dta$geometry.x <- NULL
dta$geometry.y <- NULL

library(plm)
# the number of bootstrap iterations
biters <- 50

# list to store bootstrap results
boot.res <- list()

# loop for each nonparametric bootstrap iteration
for (b in 1:biters) {
  
  # bdata <- BMisc::blockBootSample(dta, "id")
  
  unique_ids <- unique(dta$id)      #unique properties

  sample_props <- sample(unique_ids, size=length(unique_ids), replace=T ) #choose from unique props randomly with replacement
  bdata <- do.call(rbind, lapply(sample_props, function(x)  dta[dta$id==x,] ))#fetch all years for each randomly picked firm and rbind
  
  # call our function for estimating dynamic effects on the
  # bootstrapped data
  boot.res[[b]] <- compute.attgt(bdata)$dyn.ovr
  print(b)
}

# use the bootstrapped results to compute standard errors
boot.res <- t(simplify2array(boot.res))
boot.se <- sd(boot.res, na.rm = TRUE)#apply(boot.res, 1, sd)
res <- compute.attgt(dta)

# add the standard errors to the main results
treatpost.results <- res$dyn.ovr
treatpost.results$att.se <- boot.se

```
