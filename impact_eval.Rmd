---
title: "impact evaluation"
author: "Albert Garcia"
date: "Nov 11, 2020"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
---

# Methods

## NDVI time series

I generate NDVI time series for each property from 2007 to 2018 using the following procedure: 
\begin{enumerate}
\item compute NDVI for each Landsat 30m pixel that falls within a relevant property between the years 2007 and 2018
\item for each year, select each pixel's maximum NDVI value
\item to get the property's annual NDVI value, compute the mean NDVI annual maximum value from pixels that fall within the property 
\end{enumerate}

## Event study

I use a difference-in-differences event study to evaluate the impact of the subsidies through time. Treatment properties consist of properties that have been awarded a Native Forest Law subsidy between 2009 and 2018. Three separate types of properties compose my control group: unassigned properties, rejected properties, and 2019 subsidy recipients. I use 2019 recipients as controls, because they have not yet had to implement the project, as projects must be implemented by the second year after receiving the award. This is verified by a third party inspection. The viability of the analysis rests on my claim that treatment properties would have followed the same NDVI trend as control properties through time in the absence of the award. We can partially address this assumption by examining pre-trends, which I discuss later. Given that all properties in the control group have expressed their intent to enroll in the program, it seems reasonable to conclude that they have comparable opportunity costs to enrollment and alternative land-use options. The main concern to this identification assumption is the potential for anticipation effects. In the period prior to treatment, property owners may adjust their land-use in order to account for the possibility of receiving an award in the next year. This concern is mitigated in two ways: 1) Outcomes in the period immediately prior to treatment do not display a drop in NDVI consistently across groups;and 2) a robustness check in which I exclude the period immediately prior to treatment yields qualitatively similar results. I will discuss these two factors in detail in the results. 

## Why aggregate to property level?

## Why aggregate group-time treatment effects ex-post?

I use the difference-in-differences estimator proposed by Callaway and Santa'ana (2019) to mitigate concerns over issues surrounding the use of TWFE models in the presence of heterogeneous treatment effects. 
This amounts to first using a generalized propensity score method to better compare treatment and control units based on a set of covariates. Then, for each cohort, I compute the standard DID event study, before aggregating the group-time treatment effects with weights corresponding to Callaway and Santa'ana (2019). This ensures that the weights for each group-time treatment effect are not negative, and therefore, do not risk reversing the sign of the treatment effect estimate.

The current set of covariates includes:
\begin{itemize}
\item property characteristics (lattitude, longitude, area in ha, etc. )
\item award characteristics (ha subsidized, money awarded, primary project objective, etc.)
\end{itemize}

## Anticipation considerations

# Preliminary results from preferred specification

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads tidyverse packages, defines helper functions
library(latex2exp)
library(tinytex)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(stringi)
library(data.table)
library(did)
library(rio)

# library(devtools)
# install_github("bcallaway11/did")

```

``` {r NFL_data, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
#setting working directory

#setwd("C:/Users/garci/Desktop/chile_data")

# xls files downloaded from CONAF
#projects
awarded_panel <- readRDS("awarded_panel.rds")
rejected_panel <- readRDS("rejected_panel.rds")

full_panel_2006 <- awarded_panel %>%
  bind_rows(rejected_panel)%>%
  filter(Year >= 2006 & Year < 2019) %>%
  mutate(smallholder = ifelse(rptpro_tipo_concurso=="Otros Interesados", 0, 1))
```


``` {r df, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}
library(gridExtra)


full_panel <- full_panel_2006 %>%
  filter(rptpre_superficie_predial >= 0)

```

<!-- ``` {r full did, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->
<!-- did <- mp.spatt(NDVI ~ treat, data= full_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long + smallholder +  -->
<!--                   as.factor(rptpro_objetivo_manejo), -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", -->
<!--                  method = "logit", # activate to use logit, probit, lpm for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- #summary(did) -->
<!-- #summary(did$aggte) -->
<!-- ``` -->

<!-- ``` {r did full plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE} -->

<!-- #ggdid(did) -->
<!-- ggdid(did, type = "dynamic") -->


<!-- ``` -->

## comparing performance of larger properties ("other interested parties") vs. smallholders

While the average NDVI of both other interested party and smallholder landowners is nearly identical at .857 and .858, the property sizes are rather different. The median smallholder property is 32.11 hectares, while the median other interested party property is 1142.8 hectares. The average subsidy for larger properties is 69.3UTM(~/$4000), while it is 23.81UTM (~/$1400) for smallholders.


``` {r did otros interesados, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

otros_panel <- full_panel %>%
  filter(rptpro_tipo_concurso == "Otros Interesados" )#& rptpre_region != "Región de Ñuble") 

did_otros <- mp.spatt(NDVI ~ treat, data= otros_panel,
                xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long  + as.factor(rptpro_objetivo_manejo),
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year",
                 #method = "logit", # activate to use logit for propensity score matching
                 bstrap=TRUE, se=TRUE, cband=TRUE
                , cluster = "ID"
                )

```

### other interested parties

We see that other interested parties perform relatively well. Pre-trends largely seem to hold based on individual cohorts. The vast majority are not statistically different from zero, and there is no clear trend indicating that land use changes in trend prior to receiving the subsidy. We fail to reject the null that all pre-trend estimates are statistically different from zero. It is also reassuring that several different cohorts exhibit positive treatment effects through time, indicating that the effect is not overly driven by a few observations or a single  cohort. 
``` {r did otros interesados plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
ggdid(did_otros)
ggdid(did_otros, type = "dynamic")
#summary(did_otros)#$aggte)

```


### smallholders

Here, we see that smallholders see no statistically significant treatment effect from receiving a subsidy. There is a downward trend of the point estimates in fact. None of the pre-trends are statistically different from zero, and the joint hypothesis test indicates no issues. They also exhibit no worrying trends. 

``` {r did smallholders, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

smallholder_panel <- full_panel %>%
  filter(rptpro_tipo_concurso != "Otros Interesados")

did_sh <- mp.spatt(NDVI ~ treat, data= smallholder_panel,
                xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial +lat+long + as.factor(rptpro_objetivo_manejo),
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year",
                 method = "logit", # activate to use logit for propensity score matching
                 bstrap=TRUE, se=TRUE, cband=TRUE
                , cluster = "ID"
                )


summary(did_sh)#$aggte, type="dynamic")
```

``` {r did smallholders plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
ggdid(did_sh)
ggdid(did_sh, type = "dynamic")


```




<!-- \clearpage -->
<!-- ## Additional subsets -->

<!-- ### Other Interested Parties -->

<!-- #### other interested timber production -->

<!-- There is a sustained effect for other interested parties undertaking timber production projects. -->

<!-- ``` {r did timber other, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- timber_panel <- full_panel %>% -->
<!--   filter(rptpro_objetivo_manejo == "PRODUCCION MADERERA" & rptpro_tipo_concurso == "Otros Interesados") -->

<!-- did <- mp.spatt(NDVI ~ treat, data= timber_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial+lat+long, -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", -->
<!--                  method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- #summary(did) -->
<!-- ``` -->


<!-- ``` {r did timber other plots, echo = FALSE} -->

<!-- #ggdid(did) -->
<!-- ggdid(did, type = "dynamic") -->


<!-- ``` -->

<!-- #### other interested non-timber production -->

<!-- Similar to timber production, other interested parties sustain a positive treatment effect though time. -->

<!-- ``` {r did non timber others 1, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- nontimber_panel <- full_panel %>% -->
<!--   filter(rptpro_objetivo_manejo == "PRODUCCION NO MADERERA" & rptpro_tipo_concurso == "Otros Interesados") -->

<!-- did <- mp.spatt(NDVI ~ treat, data= nontimber_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial +lat +long -->
<!--                 , -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", -->
<!--                  method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->



<!-- #summary(did$aggte, type="dynamic") -->
<!-- ``` -->

<!-- ``` {r did non timber others plots 1, echo = FALSE} -->

<!-- #ggdid(did) -->

<!-- ggdid(did, type = "dynamic") -->


<!-- ``` -->
<!-- \clearpage -->

<!-- ### Smallholders -->

<!-- #### smallholder timber production -->

<!-- There is no clear effect for smallholders. -->

<!-- ``` {r did timber small, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- timber_panel <- full_panel %>% -->
<!--   filter(rptpro_objetivo_manejo == "PRODUCCION MADERERA" & rptpro_tipo_concurso != "Otros Interesados") -->

<!-- did <- mp.spatt(NDVI ~ treat, data= timber_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial+lat+long, -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", -->
<!--                  method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- #summary(did) -->
<!-- ``` -->

<!-- ``` {r did timber small plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE} -->

<!-- #ggdid(did) -->
<!-- ggdid(did, type = "dynamic") -->


<!-- ``` -->

<!-- #### smallholder non-timber production -->

<!-- This is the one case in which we do see smallholders with a positive treatment effect, although not at the magnitude of the larger property winners.  -->
<!-- ``` {r did non timber small, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- nontimber_panel <- full_panel %>% -->
<!--   filter(rptpro_objetivo_manejo == "PRODUCCION NO MADERERA" & rptpro_tipo_concurso != "Otros Interesados") -->

<!-- did <- mp.spatt(NDVI ~ treat, data= nontimber_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial #+lat+long -->
<!--                 , -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="Year", -->
<!--                  method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->


<!-- #summary(did$aggte, type="dynamic") -->
<!-- ``` -->

<!-- ``` {r did non timber small plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE} -->

<!-- #ggdid(did) -->
<!-- ggdid(did, type = "dynamic") -->


<!-- ``` -->

\clearpage
# Accounting for limited treatment anticipation

Although not the preferred specification, I now check to see how robust these results are when accounting for one-period of possible anticipation. For all estimates, I drop the period immediately prior to treatment, so that the treatment effect estimates are based on the t-2 period (where t is the year of treatment).


``` {r anticipation dataframe, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}


ant_panel <- awarded_panel %>%
  mutate(year_drop = first.treat-1,
         year_na = ifelse(Year == year_drop, NA, Year)
         )%>%
  drop_na(year_na)%>%
  mutate(year_adjusted = ifelse(Year < year_drop, Year+1, Year)
         )%>%
  bind_rows(rejected_panel)%>%
  filter(year_adjusted >= 2006 & year_adjusted < 2019 & first.treat < 2019) %>%
  mutate(smallholder = ifelse(rptpro_tipo_concurso=="Otros Interesados", 0, 1))
```



<!-- ``` {r did full, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->
<!-- library(gridExtra) -->


<!-- ant_panel <- ant_panel %>% -->
<!--   filter(rptpre_superficie_predial > 0) -->

<!-- did <- mp.spatt(NDVI ~ treat, data= ant_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long + smallholder  +as.factor(rptpro_objetivo_manejo) -->
<!--                 , -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="year_adjusted", -->
<!--                  method = "logit", # activate to use logit, probit, lpm for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- summary(did) -->
<!-- summary(did$aggte) -->
<!-- ``` -->

<!-- ``` {r did full plots, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE} -->

<!-- # ggdid(did) -->
<!-- # ggdid(did, type = "dynamic") -->


<!-- ``` -->

## comparing performance of larger properties ("other interested parties") vs. smallholders

``` {r did otros interesados ant, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

otros_ant_panel <- ant_panel %>%
  filter(rptpro_tipo_concurso == "Otros Interesados" )

did_otros <- mp.spatt(NDVI ~ treat, data= otros_ant_panel,
                xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long  + as.factor(rptpro_objetivo_manejo),
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="year_adjusted",
                 #method = "logit", # activate to use logit for propensity score matching
                 bstrap=TRUE, se=TRUE, cband=FALSE
                , cluster = "ID"
                )

```

### other interested parties


``` {r did otros interesados plots ant, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}
#summary(did_otros$aggte)
ggdid(did_otros, type = "dynamic")
```


### smallholders

Here, we see that smallholders see no statistically significant treatment effect from receiving a subsidy. There is a downward trend of the point estimates in fact. None of the pre-trends are statistically different from zero, nor do they exhibit any worrying trends. 

``` {r did smallholders ant, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE}

smallholder_ant_panel <- ant_panel %>%
  filter(rptpro_tipo_concurso != "Otros Interesados")#& rptpro_objetivo_manejo != "PRODUCCION MADERERA")

did_sh <- mp.spatt(NDVI ~ treat, data= smallholder_ant_panel,
                xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial +lat+long  +as.factor(rptpro_objetivo_manejo)
                ,
                 panel=TRUE, first.treat.name="first.treat", idname="ID", tname="year_adjusted",
                 method = "logit", # activate to use logit for propensity score matching
                 bstrap=TRUE, se=TRUE, cband=FALSE
                , cluster = "ID"
                )



#summary(did_sh$aggte, type="dynamic")
```

``` {r did smallholders plots ant, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

#summary(did_sh$aggte)
ggdid(did_sh, type = "dynamic")

```


<!-- ## Otros timber -->
<!-- ``` {r did otros interesados timber, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- otros_ant_panel <- ant_panel %>% -->
<!--   filter(rptpro_tipo_concurso == "Otros Interesados" & rptpro_objetivo_manejo == "PRODUCCION MADERERA") -->

<!-- did_otros <- mp.spatt(NDVI ~ treat, data= otros_ant_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long, -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="year_adjusted", -->
<!--                  #method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- ggdid(did_otros, type = "dynamic") -->

<!-- ``` -->

<!-- ## OTros nontimber -->

<!-- ``` {r did otros interesados nontimber, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE, eval = TRUE} -->

<!-- otros_ant_panel <- ant_panel %>% -->
<!--   filter(rptpro_tipo_concurso == "Otros Interesados" & rptpro_objetivo_manejo != "PRODUCCION MADERERA") -->

<!-- did_otros <- mp.spatt(NDVI ~ treat, data= otros_ant_panel, -->
<!--                 xformla=~ rptpro_monto_total + rptpre_superficie_bonificada + rptpre_superficie_predial + lat + long, -->
<!--                  panel=TRUE, first.treat.name="first.treat", idname="ID", tname="year_adjusted", -->
<!--                  #method = "logit", # activate to use logit for propensity score matching -->
<!--                  bstrap=TRUE, se=TRUE, cband=FALSE -->
<!--                 , cluster = "ID" -->
<!--                 ) -->

<!-- ggdid(did_otros, type = "dynamic") -->

<!-- ``` -->

