---
title: "matched data impact evaluation"
author: "Albert Garcia"
date: "Feb 17, 2021"
output:
  pdf_document:
    number_sections: yes
    toc: no
fontsize: 11pt    
documentclass: article
geometry: margin=1in
header-includes: 
  \usepackage{sectsty}
  \usepackage{enumitem}
  \usepackage{comment}
  \usepackage{multirow,array}
  \usepackage{makecell}
  \usepackage{dcolumn}
  \usepackage{booktabs}
  \usepackage[margin=1in]{geometry}
---

# Methods


## Why aggregate to property level?

## Why aggregate group-time treatment effects ex-post?

I use the difference-in-differences estimator proposed by Callaway and Santa'ana (2019) to mitigate concerns over issues surrounding the use of TWFE models in the presence of heterogeneous treatment effects. This amounts to first using a generalized propensity score method to better compare treatment and control units based on a set of covariates. Then, for each cohort, I compute the standard DID event study, before aggregating the group-time treatment effects with weights corresponding to each group's representativeness in the sample. This ensures that the weights for each group-time treatment effect are not negative, and therefore, do not risk reversing the sign of the treatment effect estimate.

# Results from matched data

```{r setup, include=FALSE}
#knitr::opts_chunk$set(out.height='300px', dpi=200)

### loads tidyverse packages, defines helper functions
# library(latex2exp)
# library(tinytex)
# library(tidyverse)
# library(ggplot2)
# library(readxl)
# library(sf)
# library(stringi)
# library(data.table)
# library(rio)

library(did)

```

``` {r did , echo = TRUE, message = TRUE, warning = TRUE, include = TRUE, eval = TRUE}

mgmtplan_analysis <- readRDS("mgmtplan_analysis.rds")
mgmtplan_analysis$id <- as.numeric(mgmtplan_analysis$id)

set.seed(0930)

xformla = ~ forest + plantation + baresoil + pasture +shrub + urban +water+ slope + elev  +area_ha+lat  +road_dist

did.mgmt <- att_gt(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     est_method = "reg",
                     xformla= xformla ,
                     data=mgmtplan_analysis, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

did.mgmt.es <- aggte(did.mgmt, type="dynamic")#, na.rm = TRUE)
ggdid(did.mgmt.es)
did.mgmt.ovr <- aggte(did.mgmt,  type = "simple")

dyn.es <- data.frame("setting" = "r=2", "att" = did.mgmt.es$att.egt, "se" = did.mgmt.es$se.egt, "e" = did.mgmt.es$egt, "crit.val" = did.mgmt.es$crit.val.egt)%>%
  mutate(period = ifelse(e >= 0 , "post", "pre"))

overall_ATTs <- data.frame("term" = "treatment", "type" = c("dynamic", "overall"),  ATT.ovr = c(did.mgmt.es$overall.att, did.mgmt.ovr$overall.att), se.ovr = c(did.mgmt.es$overall.se, did.mgmt.ovr$overall.se))

write.csv(dyn.es, "main_event_study.csv")
write.csv(overall_ATTs, "main_ATT.csv")

plot_mgmt <- ggplot(data=dyn.es, aes(x=e, y=att, color = period)) +
  geom_point() +
  geom_errorbar(aes(ymin=(att-crit.val*se), ymax=(att+crit.val*se)), width=0.1) +
  ggtitle("Event time treatment effects (r=2)") +
  xlab("years since property enrollment") + ylab("Enhanced Vegetation Index (EVI)")#+
  #geom_hline(yintercept=0, linetype = "dashed", size=0.01)
plot_mgmt
```

``` {r did plantation, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

source(here::here('lu_did_panel.R'))
source(here::here('lu_did_panel2.R'))
source(here::here('lu_compute_attgt.R'))
source(here::here('lu_att_gt.R'))
set.seed(0930)

did.landuse <- lu_att_gt(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     est_method = lu_did_panel,
                     xformla=  ~ forest + plantation + baresoil + pasture +shrub + urban +water+ slope + elev  +lat + area_ha  +road_dist  ,
                     data=mgmtplan_analysis, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     , lu_varname = "plantation"
                     )

did.forest.es <- aggte(did.landuse, type="dynamic")
did.forest.ovr <- aggte(did.landuse, type="simple")
overall_ATTs <- data.frame("term" = "plantation x treatment", "type" = c("dynamic", "overall"),  ATT.ovr = c(did.forest.es$overall.att, did.forest.ovr$overall.att), se.ovr = c(did.forest.es$overall.se, did.forest.ovr$overall.se))

did.landuse <- lu_att_gt(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     est_method = lu_did_panel2,
                     xformla= ~forest + plantation + baresoil + pasture +shrub + urban +water+ slope + elev  +lat + area_ha  +road_dist  ,
                     data=mgmtplan_analysis, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     , lu_varname = "plantation"
                     )

did.forest.es <- aggte(did.landuse, type="dynamic")
did.forest.ovr <- aggte(did.landuse, type="simple")
overall_ATTs <- rbind(overall_ATTs, 
  data.frame("term" = "treatment", "type" = c("dynamic", "overall"),  ATT.ovr = c(did.forest.es$overall.att, did.forest.ovr$overall.att), se.ovr = c(did.forest.es$overall.se, did.forest.ovr$overall.se))
)

write.csv(overall_ATTs, "plantation_ATT.csv")

```

```{r plant, echo = FALSE, message = TRUE, warning = TRUE, include = TRUE, eval = TRUE}
set.seed(0930)

rm(list = setdiff(grep("^mgmtplan|xformla", ls(), value = TRUE, invert = TRUE), lsf.str()))

term <- "pasture x treatment"

did.landuse <- lu_att_gt(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     est_method = lu_did_panel,
                     xformla=  ~ forest + plantation + baresoil + pasture +shrub + urban +water+ slope + elev  +lat + area_ha  +road_dist  ,
                     data=mgmtplan_analysis, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     , lu_varname = "pasture"
                     )

did.forest.es <- aggte(did.landuse, type="dynamic")
did.forest.ovr <- aggte(did.landuse, type="simple")
overall_ATTs <- data.frame("term" = term, "type" = c("dynamic", "overall"),  ATT.ovr = c(did.forest.es$overall.att, did.forest.ovr$overall.att), se.ovr = c(did.forest.es$overall.se, did.forest.ovr$overall.se))

did.landuse <- lu_att_gt(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     est_method = lu_did_panel2,
                     xformla= xformla,
                     data=mgmtplan_analysis, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     , lu_varname = "pasture"
                     )

did.forest.es <- aggte(did.landuse, type="dynamic")
did.forest.ovr <- aggte(did.landuse, type="simple")
overall_ATTs <- rbind(overall_ATTs, 
  data.frame("term" = "treatment", "type" = c("dynamic", "overall"),  ATT.ovr = c(did.forest.es$overall.att, did.forest.ovr$overall.att), se.ovr = c(did.forest.es$overall.se, did.forest.ovr$overall.se))
)

write.csv(overall_ATTs, "pasture_ATT.csv")



dp <- pre_process_did(yname="EVI2",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                        xformla=~   forest + plantation + baresoil + pasture +shrub + urban +water+ slope +lat+  elev  + area_ha  +road_dist ,
                        data=mgmtplan_analysis,
                     panel=TRUE,
                   allow_unbalanced_panel=FALSE,
                   control_group=c("nevertreated","notyettreated"),
                   anticipation=0,
                   weightsname=NULL,
                   alp=0.05,
                   bstrap=TRUE,
                   cband=TRUE,
                   biters=1000,
                   clustervars="id",
                   est_method="reg",
                   print_details=FALSE,
                   pl=FALSE,
                   cores=1,
                   call=match.call()
  )


```














``` {r did , echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

enrolled_analysis_2r <- readRDS("C:/Users/garci/Dropbox/chile_reforestation/data/enrolled_analysis/enrolled_analysis_ratio2unique.rds")
enrolled_analysis_2r$Year <- as.numeric(enrolled_analysis_2r$Year)
enrolled_analysis_2r$id <- as.numeric(enrolled_analysis_2r$id)
# enrolled_analysis_2r <- enrolled_analysis_2r %>%
#   mutate(pct_forest = forest*100,
#          pct_plantation = plantation*100,
#          pct_baresoil = baresoil*100,
#          pct_pasture = pasture*100,
#          pct_urban = urban*100,
#          pct_water = water*100)


did.enrolled_2r2 <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     #control_group = "notyettreated",
                     #est_method = my_did_panel,
                     xformla=~  forest + plantation + baresoil + pasture + urban +water+ slope +lat+  elev  + area_ha  +road_dist,
                     data=matched_long, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
did.es2 <- aggte(did.enrolled_2r2, type="dynamic", na.rm = TRUE, min_e=-12)#, max_e = 10)
did.es <- aggte(did.enrolled_2r, type="dynamic", na.rm = TRUE, min_e=-12)#, max_e = 10)
ggdid(did.es)
did.ovr <- aggte(did.enrolled_2r, na.rm=TRUE, type = "simple")

ATT.overall <- data.frame("reg" = "all", "att.ovr" = did.ovr$overall.att, "se.ovr" = did.ovr$overall.se, "obs" = length(unique(enrolled_analysis_2r$id)), "nearest neighbors" = 2)

# plot the event study

dyn.es <- data.frame("att" = did.es$att.egt, "se" = did.es$se.egt, "e" = did.es$egt, "crit.val" = did.es$crit.val.egt)%>%
  mutate(period = ifelse(e >= 0 , "post", "pre"))

plot_2r <- ggplot(data=dyn.es, aes(x=e, y=att, color = period)) +
  geom_point() +
  geom_errorbar(aes(ymin=(att-crit.val*se), ymax=(att+crit.val*se)), width=0.1) +
  ggtitle("Event time treatment effects for all enrolled properties (r=2)") +
  xlab("years since property enrollment") + ylab("NDVI")+
  geom_hline(yintercept=0, linetype = "dashed")
plot_2r

#######
# 1 nearest neighbor dataset
enrolled_analysis_1r <- readRDS("enrolled_analysis_ratio1unique.rds")
enrolled_analysis_1r$Year <- as.numeric(enrolled_analysis_1r$Year)
enrolled_analysis_1r$id <- as.numeric(enrolled_analysis_1r$id)

did.enrolled_1r <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=enrolled_analysis_1r, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

did.es <- aggte(did.enrolled_1r, type="dynamic", na.rm = TRUE), min_e=-10)#, max_e = 10)
did.ovr <- aggte(did.enrolled_1r, na.rm=TRUE)

ATT.overall <- ATT.overall %>%
  rbind(data.frame("reg" = "all", "att.ovr" = did.ovr$overall.att, "se.ovr" = did.ovr$overall.se, "obs" = length(unique(enrolled_analysis_1r$id)), "nearest neighbors" = 1))

# plot the event study

dyn.es <- data.frame("att" = did.es$att.egt, "se" = did.es$se.egt, "e" = did.es$egt, "crit.val" = did.es$crit.val.egt)%>%
  mutate(period = ifelse(e >= 0 , "post", "pre"))

plot_1r <- ggplot(data=dyn.es, aes(x=e, y=att, color = period)) +
  geom_point() +
  geom_errorbar(aes(ymin=(att-crit.val*se), ymax=(att+crit.val*se)), width=0.1) +
  ggtitle("Event time treatment effects for all enrolled properties (r=1)") +
  xlab("years since property enrollment") + ylab("NDVI")
plot_1r


ggsave(plot = plot_2r,
       path = "figs",
  filename = "enrolled_dynamic_2r.png",
  width = 10,
  units = "in",
  dpi = 500)
plot_1r
plot_2r
```

```{r}

score_q1.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla= ~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==1)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q1_es <- aggte(score_q1.did, type="dynamic", na.rm = TRUE)

score_q2.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==2)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q2_es <- aggte(score_q2.did, type="dynamic", na.rm = TRUE)

score_q3.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==3)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q3_es <- aggte(score_q3.did, type="dynamic", na.rm = TRUE)

score_q4.did <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(enrolled_analysis_2r, quartile ==4)
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )
q4_es <- aggte(score_q4.did, type="dynamic", na.rm = TRUE)

```

```{r}

dta <- enrolled_analysis_2r %>%
  mutate(G = first.treat,
         period = Year,
         Y = NDVI)
dta$geometry.x <- NULL

dta <- mgmtplan_analysis %>%
  mutate(G = first.treat,
         period = Year,
         Y = EVI2)
dta$geometry.x <- NULL
dta$geometry.y <- NULL
dta$geometry <- NULL
dta <- as.data.frame(dta)%>%
  mutate(female = ifelse(rptprop_sexo == "Femenino", 1, ifelse(rptprop_sexo == "Masculino", 0, NA)),
indigenous = ifelse(is.na(rptprop_etnia) & treat==1, 0, ifelse(treat==0, NA, 1)))



# the number of bootstrap iterations
biters <- 100

# list to store bootstrap results
boot.res1 <- list()
boot.res2 <- list()
boot.res3 <- list()

# loop for each nonparametric bootstrap iteration
for (b in 1:biters) {
  # draw a bootstrap sample; here, we'll call an outside function
  bdata <- BMisc::blockBootSample(dta, "id")
  att <- compute.attgt_shrub(bdata)
  # call our function for estimating dynamic effects on the
  # bootstrapped data
  boot.res1[[b]] <- att$dyn.ovr
  boot.res2[[b]] <- att$simple.att
  boot.res3[[b]] <- att$att.ovr
  print(b)
}

# use the bootstrapped results to compute standard errors
boot.res1 <- t(simplify2array(boot.res1))
boot.se1 <- sd(boot.res1)
boot.res2 <- t(simplify2array(boot.res2))
boot.se2 <- sd(boot.res2)
boot.res3 <- t(simplify2array(boot.res3))
boot.se3 <- sd(boot.res3)

results <- compute_attgt_interaction(dta, interact_var = "smallholder", interaction = TRUE)
# add the standard errors to the main results
forest.results <- data_frame(
  "ATT" = c(results$dyn.ovr , results$simple.att, results$att.ovr),
  "type" = c("dyn", "simple", "ovr"),
  "se" = c(boot.se1, boot.se2, boot.se3)
)

write.csv(forest.results, "shrub_ATT_boot.csv")



```


``` {r did , echo = FALSE, message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

paid_analysis_2r <- readRDS("paid_analysis_ratio2unique.rds")
paid_analysis_2r$Year <- as.numeric(paid_analysis_2r$Year)
paid_analysis_2r$id <- as.numeric(paid_analysis_2r$id)

did.paid_2r <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=paid_analysis_2r, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

p.did.es <- aggte(did.paid_2r, type="dynamic", na.rm = TRUE, min_e=-6, max_e = 10)
p.did.ovr <- aggte(did.paid_2r, na.rm=TRUE, type = "simple")

summary(p.did.es)
# 1 nearest neighbor dataset
paid_analysis_1r <- readRDS("paid_analysis_ratio1unique.rds")
paid_analysis_1r$Year <- as.numeric(paid_analysis_1r$Year)
paid_analysis_1r$id <- as.numeric(paid_analysis_1r$id)

did.paid_1r <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=did.paid_1r, clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

did.es <- aggte(did.paid_1r, type="dynamic", na.rm = TRUE, min_e=-6, max_e = 10)
did.ovr <- aggte(did.paid_1r, na.rm=TRUE)

```

```{r}
did.paid_ref2 <- att_gt(yname="NDVI",
                     tname="Year",
                     idname="id",
                     gname="first.treat",
                     xformla=~  lat + forest + plantation + baresoil + pasture + urban +water+ slope + elev  + area_ha + road_dist ,
                     data=subset(paid_analysis_2r, rptpro_objetivo_manejo.x == "BOSQUE PRESERVACION Y FORMACIONES XEROFITICAS DE ALTO VALOR ECOLOGICO"
                                # reforestation2==1
                                 |treat==0 )
                     , clustervars = "id"
                     , panel=TRUE, bstrap = TRUE
                     )

p.did.es <- aggte(did.paid_ref2, type="dynamic", na.rm = TRUE)#, min_e=-6, max_e = 10)

```

```{r}
# setwd("C:/Users/garci/Dropbox/chile_reforestation/data/property_ndvi/new_CIREN_ndvi/treatment")
# # load los rios ndvi time series for all ciren properties
# temp = list.files(pattern="*.csv")
# rolarea_ndvi = bind_rows(lapply(temp, read_csv))%>%
#   select(prop_ID, year, mean) %>%
#   distinct(prop_ID, year, .keep_all = TRUE) %>%
#   mutate(year = paste0("y_", year))%>%
#   spread(key = "year", value = "mean")# cast ndvi into wide format

```

```{r}
rolarea_covars <- data.frame(readRDS("rolarea_covars.rds"))
rolarea_df <- readRDS("rolarea_df.rds")

enrolled_df <- rolarea_df %>%
  inner_join(rolarea_covars, by ="prop_ID")%>%
  mutate(forest = c_1,
         plantation = c_3,
         baresoil = c_12,+c_10,
         pasture = c_9,
         water = c_15,
         urban = c_16,
         timber = ifelse(rptpro_objetivo_manejo.x == "PRODUCCION MADERERA", 1, 0),
         nontimber = ifelse(rptpro_objetivo_manejo.x == "PRODUCCION NO MADERERA", 1, 0),
         ecologio = ifelse(rptpro_objetivo_manejo.x == "BOSQUE PRESERVACION Y FORMACIONES XEROFITICAS DE ALTO VALOR ECOLOGICO", 1, 0),
         female = ifelse(rptprop_sexo == "Masculino", 0, 1),
         indigenous = ifelse(rptprop_etnia == "Aymara" | rptprop_etnia == "Mapuche" | rptprop_etnia == "Otra", 1, 0),
         smallholder = ifelse(rptpro_tipo_concurso == "Otros Interesados", 0, 1))


library(gplots)
plotmeans(plantation ~ first.treat, data = enrolled_df, n.label = FALSE)

plotmeans(`rptpro_monto_total` ~ first.treat, data = enrolled_df)

plotmeans(rptpro_objetivo_manejo.x ~ first.treat, data = enrolled_df)

plotmeans(pasture ~ first.treat, data = enrolled_df)

plotmeans(reforestation2 ~ first.treat, data = enrolled_df)

plotmeans(forest ~ first.treat, data = enrolled_df)

enrolled_df$smallholder <- as.character(enrolled_df$smallholder)
pd <- position_dodge(0.2)


ggplot(summarySE(enrolled_df, measurevar="pasture", groupvars=c("first.treat","smallholder"), na.rm = TRUE), 
       aes(x=first.treat, y=pasture, colour=smallholder)) + 
    geom_errorbar(aes(ymin=pasture-se, ymax=pasture+se), width=.1) +
    geom_line() +
    geom_point()

ggplot(summarySE(enrolled_df, measurevar="ecologio", groupvars=c("first.treat","smallholder"), na.rm = TRUE), 
       aes(x=first.treat, y=ecologio, colour=smallholder)) + 
    geom_errorbar(aes(ymin=ecologio-se, ymax=ecologio+se), width=.1) +
    geom_line() +
    geom_point()


```

```{r}
propertypaid_id
paid.enrolled <- enrolled_df %>%
  left_join(propertypaid_id) %>%
  mutate(paid = ifelse(is.na(paid), 0, paid))

summary(paid.enrolled$paid)

proppaid <- property_df %>%
  #filter(first.treat == rptpro_ano)%>%
  distinct(prop_ID, .keep_all = TRUE)%>%
  left_join(propertypaid_id, by = "prop_ID")%>%
  mutate(paid = ifelse(is.na(paid), 0, paid))

plotmeans(paid ~ first.treat, data = paid.enrolled)

plotmeans(paid ~ first.treat, data = proppaid)

plotmeans(paid ~ as.numeric(yr_paid), data = propertypaid_id)
class(propertypaid_id$yr_paid)

paid.enrolled$smallholder <- as.character(paid.enrolled$smallholder)
paid.enrolled$reforestation2 <- as.character(paid.enrolled$reforestation2)

ggplot(summarySE(subset(paid.enrolled, first.treat < 2018), measurevar="paid", groupvars=c("first.treat","ecologio"), na.rm = TRUE), 
       aes(x=first.treat, y=paid, colour=ecologio)) + 
    geom_errorbar(aes(ymin=paid-se, ymax=paid+se), width=.1) +
    geom_line() +
    geom_point()

```


